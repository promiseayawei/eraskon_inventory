<!DOCTYPE html>
<!-- Coding by CodingNepal || www.codingnepalweb.com -->
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Boxicons CSS -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <title>Eraskon Inventory Management</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>

<body>
 <!-- Load Navbar -->
  <script src="components/navbar.js"></script>

  <!-- Load Sidebar -->
  <script src="components/sidebar.js"></script>
    
  <!-- Main Content -->
  <main id="app" class="main-content">
    <div class="cards">
      <div class="card" v-for="card in cards" :key="card.title">
        <h3>{{ card.title }}</h3>
        <p>{{ card.value }}</p>
      </div>
    </div>


    <div class="chart-row" style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
      <div class="chart-container"
        style=" flex: 1; min-width: 300px;padding: 16px;background-color: var(--container-bg);border-radius: 10px;transition: background 0.3s, color 0.3s;">

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h4 style="margin: 0;">Sales Chart</h4>
          <div>
            <select v-model="selectedMonth" @change="drawChart()">
              <option value="all">All Months</option>
              <option v-for="month in availableMonths" :key="month" :value="month">{{ month }}</option>
            </select>
            <button @click="downloadChart('salesChart', 'Sales_Report.png')">Download</button>
          </div>
        </div>
        <canvas id="salesChart"></canvas>
      </div>

      <div class="chart-container"
        style=" flex: 1; min-width: 300px;padding: 16px;background-color: var(--container-bg);border-radius: 10px;transition: background 0.3s, color 0.3s;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h4 style="margin: 0;">Product Stock</h4>
          <button @click="downloadChart('productChart', 'Product_Stock.png')">Download</button>
        </div>
        <canvas id="productChart"></canvas>
      </div>
    </div>




    <div class="table-section">
      <input type="text" v-model="search" placeholder="Search products..." class="table-search" />
      <table>
        <thead>
          <tr>
            <th @click="sort('name')">Name</th>
            <th @click="sort('category')">Category</th>
            <th @click="sort('stock')">Stock</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="product in filteredProducts" :key="product.id">
            <td>{{ product.name }}</td>
            <td>{{ product.category }}</td>
            <td>{{ product.stock }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>
 
  <!-- JavaScript -->
  <script src="assets/js/script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
 <script src="config.js"></script>


  <script>
     const API_BASE = window.BASE_URL;

    function toggleSidebar() {
      document.body.classList.toggle('collapsed');
    }

    new Vue({
      el: '#app',
      data: {
        cards: [
          { title: 'Total Products', value: 0 },
          { title: 'Total Sales', value: 0 },
          { title: 'Available Stock', value: 0 }
        ],
        search: '',
        sortKey: '',
        sortAsc: true,
        selectedMonth: 'all',
        products: [],
        orders: [],
        salesChart: null,
        productChart: null,
        salesData: {}
      },
      computed: {
        availableMonths() {
          return Object.keys(this.salesData);
        },
        filteredProducts() {
          let list = this.products.filter(p =>
            p.name.toLowerCase().includes(this.search.toLowerCase())
          );
          if (this.sortKey) {
            list.sort((a, b) => {
              const result = a[this.sortKey] > b[this.sortKey] ? 1 : -1;
              return this.sortAsc ? result : -result;
            });
          }
          return list;
        }
      },
      methods: {
        sort(key) {
          if (this.sortKey === key) {
            this.sortAsc = !this.sortAsc;
          } else {
            this.sortKey = key;
            this.sortAsc = true;
          }
        },
        getCSSVar(varName) {
          return getComputedStyle(document.body).getPropertyValue(varName).trim();
        },
        downloadChart(chartId, fileName) {
          const canvas = document.getElementById(chartId);
          const a = document.createElement('a');
          a.href = canvas.toDataURL('image/png');
          a.download = fileName;
          a.click();
        },
        getTextColor() {
          return document.body.classList.contains('dark-mode') ? '#ffffff' : '#000000';
        },
        async fetchData() {
          try {
            const token = localStorage.getItem('token');
            // Fetch products
            const prodRes = await fetch(`${API_BASE}/products`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            const prodData = await prodRes.json();
            this.products = Array.isArray(prodData) ? prodData : (prodData.products || []);
            // Fetch orders
            const orderRes = await fetch(`${API_BASE}/order`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            const orderData = await orderRes.json();
            this.orders = Array.isArray(orderData) ? orderData : (orderData.orders || []);
            // Update cards
            let totalAmount = 0;
            if (this.orders.length) {
              totalAmount = this.orders.reduce((sum, o) => sum + (Number(o.total) || 0), 0);
            }
            this.cards = [
              { title: 'Total Products', value: this.products.length },
              { title: 'Total Sales', value: this.orders.length },
              { title: 'Available Stock', value: this.products.reduce((sum, p) => sum + (p.stock || 0), 0) },
              { title: 'Total Amount', value: `â‚¦${totalAmount.toLocaleString()}` }
            ];
            // Prepare salesData for chart
            this.prepareSalesData();
            this.drawChart();
          } catch (err) {
            alert('Error loading data: ' + err.message);
          }
        },
        prepareSalesData() {
          // Example: group orders by month for salesData
          const salesData = {};
          this.orders.forEach(order => {
            const date = new Date(order.createdAt);
            const month = date.toLocaleString('default', { month: 'short' });
            if (!salesData[month]) salesData[month] = [0, 0];
            // Example: order.channel === 'online' or 'offline'
            if (order.channel === 'online') salesData[month][0] += 1;
            else salesData[month][1] += 1;
          });
          this.salesData = salesData;
        },
        drawChart() {
          const lineColor1 = this.getCSSVar('--blue-color') || '#4A90E2';
          const lineColor2 = '#FF6B6B';
          const barColor = this.getCSSVar('--grey-color') || '#777';
          const textColor = this.getTextColor();

          if (this.salesChart) this.salesChart.destroy();
          if (this.productChart) this.productChart.destroy();

          const ctxSales = document.getElementById("salesChart").getContext("2d");
          const ctxProduct = document.getElementById("productChart").getContext("2d");

          let labels = [];
          let dataset1 = [], dataset2 = [];

          if (this.selectedMonth === 'all') {
            labels = Object.keys(this.salesData);
            dataset1 = labels.map(m => this.salesData[m][0]);
            dataset2 = labels.map(m => this.salesData[m][1]);
          } else {
            labels = [this.selectedMonth];
            dataset1 = [this.salesData[this.selectedMonth][0]];
            dataset2 = [this.salesData[this.selectedMonth][1]];
          }

          // Sales chart (line chart)
          this.salesChart = new Chart(ctxSales, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Online Sales",
                  data: dataset1,
                  borderColor: lineColor1,
                  backgroundColor: lineColor1 + '30',
                  tension: 0.4,
                  fill: true,
                  pointBackgroundColor: lineColor1
                },
                {
                  label: "Offline Sales",
                  data: dataset2,
                  borderColor: lineColor2,
                  backgroundColor: lineColor2 + '30',
                  tension: 0.4,
                  fill: true,
                  pointBackgroundColor: lineColor2
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { labels: { color: textColor } },
                tooltip: {
                  backgroundColor: textColor,
                  titleColor: barColor,
                  bodyColor: barColor
                },
                datalabels: {
                  color: textColor,
                  anchor: 'end',
                  align: 'top',
                  font: { weight: 'bold' },
                  formatter: Math.round
                }
              },
              scales: {
                x: {
                  ticks: { color: textColor },
                  grid: { color: textColor + '20' }
                },
                y: {
                  beginAtZero: true,
                  ticks: { color: textColor },
                  grid: { color: textColor + '20' }
                }
              }
            },
            plugins: [ChartDataLabels]
          });

          // Product chart (bar chart)
          this.productChart = new Chart(ctxProduct, {
            type: "bar",
            data: {
              labels: this.products.map(p => p.name),
              datasets: [{
                label: "Stock Level",
                data: this.products.map(p => p.stock),
                backgroundColor: barColor,
                borderRadius: 6,
                borderSkipped: false
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { labels: { color: textColor } },
                tooltip: {
                  backgroundColor: textColor,
                  titleColor: barColor,
                  bodyColor: barColor
                },
                datalabels: {
                  color: textColor,
                  anchor: 'end',
                  align: 'top',
                  font: { weight: 'bold' },
                  formatter: Math.round
                }
              },
              scales: {
                x: {
                  ticks: { color: textColor },
                  grid: { display: false }
                },
                y: {
                  beginAtZero: true,
                  ticks: { color: textColor },
                  grid: { display: false }
                }
              }
            },
            plugins: [ChartDataLabels]
          });
        }
      },
      mounted() {
        this.fetchData();
        const observer = new MutationObserver(() => this.drawChart());
        observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
      }
    });
  </script>
  




</body>

</html>