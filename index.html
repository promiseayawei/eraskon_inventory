<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Eraskon | Login & Activation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="components/spinner.js"></script>
  <link rel="stylesheet" href="assets/css/style_auth.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

<script src="assets/js/metaManager.js"></script>
  <script>
    setMeta({
      title: "Eraskon | login & Activation",
      desc: "Access the Eraskon Inventory portal to login or activate your account.",
      image: "assets/images/eraskon_logo.webp",
      favicon: "assets/images/eraskon_logo.webp",
      keywords: "Inventory, Warehouse, Stock, Sales, Login, Activation"
    });
  </script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, .2);
      margin: 3em auto 1em;
      max-width: 720px;
      width: 100%;
    }

    .logo-header {
      display: flex;
      align-items: center;
      gap: 1em;
      margin-top: 2em;
      color: #f3f0f0;
      text-align: center;
      padding: 0 10px;
    }

    .logo-header img {
      height: 4em;
      width: 4em;
      max-width: 100%;
      height: auto;
    }

    .logo-header h1 {
      font-size: 2em;
      margin: 0;
    }

    .message-box {
      display: none;
      margin-bottom: 0.8em;
      padding: 1em 1.5em;
      border-radius: 8px;
      max-width: 400px;
      font-weight: 600;
      text-align: center
    }

    .message-box.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb
    }

    .message-box.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb
    }

    /* Combined form styling for consistency and alignment */
    .login-form,
    .signup-form,
    .forgot-password-form,
    .complete-reset-form {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      padding: 0 20px;
      box-sizing: border-box;
    }

    .input-box {
      margin: 1.2em 0;
      position: relative;
    }

    .input-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      z-index: 2;
      font-size: 1.1em;
    }

    .input-box input {
      border-radius: 10px;
      border: 1px solid #ddd;
      padding: 12px 12px 12px 40px;
      outline: none;
      font-size: 1em;
      height: 48px;
      width: 100%;
      box-sizing: border-box;
      transition: border-color .3s, box-shadow .3s;
      background-color: #f9f9f9;
    }

    .input-box input:focus {
      border-color: #0056b3;
      box-shadow: 0 0 0 2px rgba(0, 86, 179, .2);
      background-color: #fff;
    }

    .button.input-box {
      margin-top: 2em;
    }

    .button input[type="submit"] {
      background-color: #007bff;
      color: white;
      font-weight: 700;
      cursor: pointer;
      padding: 12px 20px;
      height: 50px;
      border: none;
      border-radius: 10px;
      transition: background-color 0.3s;
      width: 100%;
    }

    .button input[type="submit"]:hover {
      background-color: #0056b3;
    }

    footer {
      text-align: center;
      padding: 1em 0;
      font-size: .9em;
      color: #f1f1f1
    }

    .reset-intro-text {
      font-size: 15px;
      color: #555;
      margin: 1em auto 2em;
      padding: 0 10px;
      line-height: 1.4;
      text-align: center;
      max-width: 360px;
    }

    /* --- MOBILE-FRIENDLY IMPROVEMENTS --- */
    @media (max-width: 600px) {
      .logo-header {
        margin-top: 1.5em;
        flex-direction: row;
        align-items: center;
        width: 100%;
        justify-content: center;
      }

      .logo-header img {
        height: 2.5em;
        width: 2.5em;
      }

      .logo-header h1 {
        font-size: 1.2em;
        white-space: normal;
        line-height: 1.2;
        max-width: 70%;
      }

      .container {
        width: calc(100% - 20px);
        margin: 1em 10px;
        padding: 10px;
        overflow: hidden;
      }

      .cover {
          display: none !important; 
      }
      
      .forms {
        width: 100%;
      }

      .form-content {
        display: flex;
        width: 100%;
        transition: transform 0.6s ease-in-out;
        min-height: 450px; 
        padding: 10px 0;
      }

      .login-form,
      .signup-form,
      .forgot-password-form,
      .complete-reset-form { /* Added complete-reset-form */
        min-width: 100%; 
        max-width: none;
        padding: 0 10px;
        box-sizing: border-box;
      }

      #flip:checked~.forms .form-content {
        transform: translateX(-100%);
      }
      
      .message-box {
        max-width: 100%;
        margin-left: 0;
        margin-right: 0;
      }
    }
  </style>
</head>

<body>
  <script src="components/uiComponents.js"></script>
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="assets/js/utils.js"></script>

  <div class="logo-header animated delay-1">
    <img src="assets/images/eraskon_logo.webp" alt="Eraskon Logo">
    <h1>Eraskon Inventory Management Solution</h1>
  </div>

  <div class="container animated delay-2">
    <input type="checkbox" id="flip">
    
    <div class="cover">
      <div class="front">
        <img src="assets/images/erasko_gold.png" alt="">
        <div class="text"><span class="text-1">Eraskon <br> Inventory</span><span class="text-2">Ready Let's go</span>
        </div>
      </div>
      <div class="back">
        <img class="backImg" src="assets/images/eraskon image2.jpeg" alt="">
        <div class="text"><span class="text-1">Inventory Systems<br> Automation</span><span class="text-2">Let's get
            started</span></div>
      </div>
    </div>

    <div class="forms animated delay-3">
      <div class="form-content">
        
        <div class="login-form">
          <div id="loginMessageBox" class="message-box"></div>
          <div class="title">Login</div>
          <form id="loginForm">
            <div class="input-boxes">
              <div class="input-box"><i class="fas fa-envelope"></i><input type="text" placeholder="Enter your email"
                  required autocomplete="email"></div>
              <div class="input-box"><i class="fas fa-lock"></i><input type="password" placeholder="Enter your password"
                  required autocomplete="current-password"></div>
              
              <div class="text"><a href="#" class="forgot-password-link">Forgot password?</a></div>
              
              <div class="button input-box"><input type="submit" value="Submit"></div>
              <div class="text sign-up-text">Don't have login credentials? <label for="flip">Activate Account</label>
              </div>
            </div>
          </form>
        </div>
        
        <div class="forgot-password-form" style="display: none;">
          <div id="forgotMessageBox" class="message-box"></div>
          <div class="title">Forgot Password</div>
          <form id="forgotPasswordForm">
            <p class="reset-intro-text">Enter your email address to receive a password reset link.</p>
            <div class="input-boxes">
              <div class="input-box"><i class="fas fa-envelope"></i><input type="email" id="forgotEmail" placeholder="Enter your email" required autocomplete="email"></div>
              <div class="button input-box"><input type="submit" value="Send Reset Link"></div>
              <div class="text sign-up-text"><a href="#" class="back-to-login-link">Back to Login</a></div>
            </div>
          </form>
        </div>

        <div class="complete-reset-form" style="display: none;">
            <div id="completeResetMessageBox" class="message-box"></div>
            <div class="title">Set New Password</div>
            <form id="completeResetForm">
                <p class="reset-intro-text">Enter your new password below to complete the reset process.</p>
                <div class="input-boxes">
                    <div class="input-box"><i class="fas fa-lock"></i><input type="password" id="newPwd" placeholder="New Password" required autocomplete="new-password"></div>
                    <div class="input-box"><i class="fas fa-lock"></i><input type="password" id="confirmNewPwd" placeholder="Confirm New Password" required autocomplete="new-password"></div>
                    <div class="button input-box"><input type="submit" value="Reset Password"></div>
                    <div class="text sign-up-text"><a href="/" class="back-to-login-link">Go to Login</a></div>
                </div>
            </form>
        </div>
        
        <div class="signup-form">
          <div id="signupMessageBox" class="message-box"></div>
          <div class="title">Signup Account</div>
          <form id="signupForm">
            <div class="input-boxes">
              <div class="input-box"><i class="fas fa-envelope"></i><input type="text" placeholder="Enter your email"
                  required autocomplete="email"></div>
              <div class="input-box"><i class="fas fa-user"></i><input type="text" placeholder="First name" required
                  autocomplete="given-name"></div>
              <div class="input-box"><i class="fas fa-user"></i><input type="text" placeholder="Last name" required
                  autocomplete="family-name"></div>
              <div class="input-box"><i class="fas fa-lock"></i><input type="password" placeholder="Enter your password"
                  required autocomplete="new-password"></div>
              <div class="input-box"><i class="fas fa-lock"></i><input type="password"
                  placeholder="Confirm your password" required autocomplete="new-password"></div>
              <div class="button input-box"><input type="submit" value="Submit"></div>
              <div class="text sign-up-text">Already have an account? <label for="flip">Login now</label></div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <footer class="forms animated delay-4">&copy; 2025 Eraskon Inventory. All rights reserved || Developed by <a
      href="https://github.com/ayaweisoft">Ayaweisoft</a></footer>

  <script>
    // Constants and DOM element fetching
    const API_BASE = window.BASE_URL;
    const loginForm = document.getElementById("loginForm");
    const signupForm = document.getElementById("signupForm");
    const forgotPasswordForm = document.getElementById("forgotPasswordForm");
    const completeResetForm = document.getElementById("completeResetForm");

    const loginFormContainer = document.querySelector(".login-form");
    const forgotFormContainer = document.querySelector(".forgot-password-form");
    const completeResetFormContainer = document.querySelector(".complete-reset-form");
    const coverElement = document.querySelector('.cover');

    // --- Utility Functions ---
    const setFormState = (f, l) => { 
      const s = f.querySelector('input[type="submit"]'); 
      s.disabled = l; 
      if (!f.dataset.originalValue) f.dataset.originalValue = s.value;
      s.value = l ? "Loading..." : f.dataset.originalValue; 
      l ? window.showSpinner && showSpinner() : window.hideSpinner && hideSpinner() 
    };
    
    const showMessage = (id, m, t = "success") => { 
      const b = document.getElementById(id); 
      b.textContent = m; 
      b.className = `message-box ${t}`; 
      b.style.display = "block"; 
      setTimeout(() => b.style.display = "none", 5e3) 
    };

    const toggleForgotForm = (showForgot = true) => {
        loginFormContainer.style.display = showForgot ? "none" : "block";
        forgotFormContainer.style.display = showForgot ? "block" : "none";
        document.getElementById('flip').checked = false; // Ensure signup is hidden
        completeResetFormContainer.style.display = 'none'; // Ensure reset form is hidden
    };

    // Function to extract token from URL (e.g., /reset-password/TOKEN_HERE)
    const getTokenFromUrl = () => {
        const path = window.location.pathname;
        const parts = path.split('/');
        // Check for /reset-password/ and a token segment
        if (parts[1] === 'reset-password' && parts.length === 3 && parts[2].length > 10) {
            return parts[2];
        }
        return null;
    };


    // --- 0. Initial Page Load Check for Reset Token ---
    const resetToken = getTokenFromUrl();

    if (resetToken) {
        // We are on the reset page. Hide all non-reset elements.
        coverElement.style.display = 'none';
        loginFormContainer.style.display = 'none';
        forgotFormContainer.style.display = 'none';
        document.querySelector('.signup-form').style.display = 'none';
        document.getElementById('flip').style.display = 'none'; // Hide checkbox

        // Show the complete reset form
        completeResetFormContainer.style.display = 'block';
        
        // Ensure the form content container is not horizontally aligned for the flip effect
        document.querySelector('.forms .form-content').style.transform = 'none';
        document.querySelector('.forms .form-content').style.display = 'block';

    } else {
        // Normal login page load. Ensure login is visible by default.
        loginFormContainer.style.display = 'block';
    }

    // --- 1. Login Form Submission (Unchanged) ---
    loginForm.addEventListener("submit", e => {
      e.preventDefault(); 
      setFormState(loginForm, 1); 
      const [email, pwd] = [...e.target.querySelectorAll("input")].map(i => i.value);
      axios.post(`${API_BASE}/auth/login`, { email, password: pwd }).then(r => {
        setFormState(loginForm, 0); 
        const { token, user } = r.data; 
        Object.entries({ token, email: user.email, role: user.role, name: `${user.firstName} ${user.lastName}`, firstName: user.firstName, lastName: user.lastName, userId: user._id, warehouse: user.warehouse?.name || user.warehouse || "" }).forEach(([k, v]) => localStorage.setItem(k, v)); 
        showMessage("loginMessageBox", "Login successful!", "success");
        const m = { admin: "stats.html", inventory: "stock-movement.html", sales: "store.html", warehouse: "warehouse.html", finance: "approve.html", chairman: "chairman.html" }; 
        setTimeout(() => location.href = m[user.role] || "welcome.html", 1500);
      }).catch(e => { 
        setFormState(loginForm, 0); 
        showMessage("loginMessageBox", e.response?.data?.error || "Login failed.", "error") 
      });
    });

    // 2. Signup Form Submission (Unchanged)
    signupForm.addEventListener("submit", e => {
      e.preventDefault(); 
      setFormState(signupForm, 1); 
      const [email, firstName, lastName, password, confirmPassword] = [...e.target.querySelectorAll("input")].map(i => i.value);
      
      if (password !== confirmPassword) return setFormState(signupForm, 0), showMessage("signupMessageBox", "Passwords do not match", "error");
      
      axios.post(`${API_BASE}/auth/register`, { email, firstName, lastName, password }).then(r => { 
        setFormState(signupForm, 0); 
        showMessage("signupMessageBox", r.data.message || "Account activated! Please log in.", "success") 
      }).catch(e => { 
        setFormState(signupForm, 0); 
        showMessage("signupMessageBox", e.response?.data?.error || "Activation failed. Check if account already exists.", "error") 
      });
    });

    // 3. Forgot Password Toggle & Submission (Unchanged)
    document.querySelector(".forgot-password-link").addEventListener("click", e => {
        e.preventDefault(); 
        toggleForgotForm(true);
        document.getElementById("loginMessageBox").style.display = "none";
        coverElement.style.display = 'none'; // Hide cover when showing forgot form
    });

    document.querySelector(".back-to-login-link").addEventListener("click", e => {
        e.preventDefault(); 
        toggleForgotForm(false);
        document.getElementById("forgotEmail").value = ""; 
        document.getElementById("forgotMessageBox").style.display = "none"; 
        coverElement.style.display = 'block'; // Show cover when going back to login
    });

    forgotPasswordForm.addEventListener("submit", e => {
        e.preventDefault(); 
        setFormState(forgotPasswordForm, 1);
        const email = document.getElementById("forgotEmail").value;
        forgotPasswordForm.querySelector('input[type="submit"]').dataset.originalValue = "Send Reset Link";

        axios.post(`${API_BASE}/auth/forgot-password`, { email })
            .then(r => {
                setFormState(forgotPasswordForm, 0); 
                showMessage("forgotMessageBox", r.data.message || "Password reset link sent!", "success"); 
                document.getElementById("forgotEmail").value = "";
            })
            .catch(err => {
                setFormState(forgotPasswordForm, 0); 
                const genericMsg = "If an account with that email exists, a password reset link has been sent.";
                showMessage("forgotMessageBox", genericMsg, "success"); 
            });
    });

    // 4. NEW: Complete Password Reset Submission Handler
    completeResetForm.addEventListener("submit", e => {
        e.preventDefault(); 
        setFormState(completeResetForm, 1);

        const newPassword = document.getElementById('newPwd').value;
        const confirmNewPassword = document.getElementById('confirmNewPwd').value;

        if (newPassword !== confirmNewPassword) {
            setFormState(completeResetForm, 0); 
            return showMessage("completeResetMessageBox", "Passwords do not match.", "error");
        }

        const submissionData = {
            token: resetToken, // Use the token extracted on page load
            newPassword: newPassword
        };
        
        // Use the updated, clean endpoint
        axios.post(`${API_BASE}/auth/complete-password-reset`, submissionData)
            .then(r => {
                setFormState(completeResetForm, 0); 
                showMessage("completeResetMessageBox", r.data.message || "Password updated! Redirecting to login...", "success"); 
                // Redirect user back to the main login page after a few seconds
                setTimeout(() => {
                    window.location.href = '/'; 
                }, 3000);
            })
            .catch(err => {
                setFormState(completeResetForm, 0); 
                showMessage("completeResetMessageBox", err.response?.data?.error || "Reset failed. Link may be expired or invalid.", "error"); 
            });
    });

    window.addEventListener("load", () => {
        // Only hide spinner if the page is not displaying the reset form (where loading might be longer)
        if (!resetToken) { 
            window.hideSpinner && hideSpinner();
        }
    });
  </script>

</body>

</html>