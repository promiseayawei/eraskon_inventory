<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Logistics Management - Eraskon Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <script>
    setMeta({
      title: "Eraskon | logistics",
      desc: "Access the Eraskon Inventory portal to manage Logistics.",
      image: "assets/images/eraskon_logo.webp",
      favicon: "assets/images/eraskon_logo.webp",
      keywords: "Inventory, Warehouse, Stock, Sales, Logistics"
    });
  </script>
  <style>
           /* Sidebar */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  height: 100%;
  padding: 80px 5px;
  z-index: 100;
  overflow-y: auto;
  box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
  transition: all var(--transition-speed) ease;
  width: var(--sidebar-width);
  background-color: var(--white-color); 
}
.sidebar.close {
  width: var(--collapsed-sidebar-width);
}
.sidebar .nav_link {
  color: var(--grey-color);
}
.nav_link:hover {
  color: white;
  background: var(--primary-blue); 
  border-radius: var(--border-radius-base);
}
.sidebar.close .bottom_content {
  width: 50px;
  left: 15px;
}
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-bg: #e2dcdc;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --table-header: #f3eded;
      --white: #f3eded;
      --text: #222;
      --shadow: 0 2px 8px #0001;
    }

    

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--primary-bg);
      color: var(--text);
      padding: 20px 17%;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding-left: 17%;
      
    }

    .header {
      background: var(--white);
      padding: 24px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }

    .header h1 {
      color: var(--primary);
      margin-bottom: 8px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      background: var(--white);
      padding: 8px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      overflow-x: auto;
    }

    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
      transition: all 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab:hover {
      background: var(--primary-bg);
    }

    .tab.active {
      background: var(--primary);
      color: var(--white);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--white);
      padding: 24px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 16px;
      border-left: 4px solid var(--primary);
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
    }

    .stat-card i {
      font-size: 2.5em;
      color: var(--primary);
    }

    .stat-info h3 {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 4px;
    }

    .stat-info .value {
      font-size: 2em;
      font-weight: 700;
      color: var(--text);
    }

    .card {
      background: var(--white);
      padding: 24px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-header h2 {
      color: var(--primary);
      font-size: 1.5em;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }

    .btn-primary:hover {
      background: var(--primary-light);
    }

    .btn-success {
      background: var(--success);
      color: var(--white);
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: var(--danger);
      color: var(--white);
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .btn-warning {
      background: var(--warning);
      color: var(--white);
    }

    .btn-warning:hover {
      background: #d97706;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.9em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      background: var(--table-header);
      color: var(--primary);
      font-weight: 600;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 600;
      display: inline-block;
    }

    .badge-success {
      background: #d1fae5;
      color: var(--success);
    }

    .badge-danger {
      background: #fee2e2;
      color: var(--danger);
    }

    .badge-warning {
      background: #fef3c7;
      color: var(--warning);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--white);
      padding: 32px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-header h3 {
      color: var(--primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    .close-btn:hover {
      background: #f3f4f6;
      color: var(--danger);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--primary);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1em;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .chart-container {
      background: var(--white);
      padding: 24px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .empty-state i {
      font-size: 4em;
      color: #ccc;
      margin-bottom: 16px;
    }

    @media (max-width: 768px) {
      body {
      
      padding: 0%;
    }

    .container {
      
      padding-left: 0%;
      
    }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .card-header {
        flex-direction: column;
        align-items: stretch;
      }

      table {
        font-size: 0.9em;
      }

      th, td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <script src="components/spinner.js"></script>
  <script src="components/authGuard.js"></script>
  <script src="components/navbar.js"></script>
  <script src="components/sidebar.js"></script>

  <div class="container">
    <div class="header">
      <h1><i class="bx bx-truck"></i> Logistics Management System</h1>
      <p>Manage logistics partners, drivers, and trips</p>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="analytics"><i class="bx bx-bar-chart"></i> Analytics</button>
      <button class="tab" data-tab="logistics"><i class="bx bx-buildings"></i> Logistics Partners</button>
      <button class="tab" data-tab="drivers"><i class="bx bx-car"></i> Drivers</button>
      <button class="tab" data-tab="trips"><i class="bx bx-trip"></i> Trips</button>
    </div>

    <!-- Analytics Tab -->
    <div class="tab-content active" id="analytics">
      <div class="stats-grid">
        <div class="stat-card">
          <i class="bx bx-buildings"></i>
          <div class="stat-info">
            <h3>Total Partners</h3>
            <div class="value" id="totalPartners">0</div>
          </div>
        </div>
        <div class="stat-card">
          <i class="bx bx-car"></i>
          <div class="stat-info">
            <h3>Total Drivers</h3>
            <div class="value" id="totalDrivers">0</div>
          </div>
        </div>
        <div class="stat-card">
          <i class="bx bx-check-shield"></i>
          <div class="stat-info">
            <h3>Available Drivers</h3>
            <div class="value" id="availableDrivers">0</div>
          </div>
        </div>
        <div class="stat-card">
          <i class="bx bx-trip"></i>
          <div class="stat-info">
            <h3>Total Trips</h3>
            <div class="value" id="totalTrips">0</div>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <h3 style="color: var(--primary); margin-bottom: 20px;">Monthly Trips Overview</h3>
        <canvas id="tripsChart"></canvas>
      </div>
    </div>

    <!-- Logistics Partners Tab -->
    <div class="tab-content" id="logistics">
      <div class="card">
        <div class="card-header">
          <h2>Logistics Partners</h2>
          <button class="btn btn-primary" id="addPartnerBtn">
            <i class="bx bx-plus"></i> Add Partner
          </button>
        </div>
        <div style="overflow-x: auto;">
          <table id="logisticsTable">
            <thead>
              <tr>
                <th>Service ID</th>
                <th>Provider</th>
                <th>Contact</th>
                <th>Service Area</th>
                <th>Drivers</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Drivers Tab -->
    <div class="tab-content" id="drivers">
      <div class="card">
        <div class="card-header">
          <h2>All Drivers</h2>
          <button class="btn btn-primary" id="addDriverBtn">
            <i class="bx bx-plus"></i> Add Driver
          </button>
        </div>
        <div style="overflow-x: auto;">
          <table id="driversTable">
            <thead>
              <tr>
                <th>Driver Name</th>
                <th>Partner</th>
                <th>Vehicle</th>
                <th>Phone</th>
                <th>Status</th>
                <th>Availability</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Trips Tab -->
    <div class="tab-content" id="trips">
      <div class="card">
        <div class="card-header">
          <h2>Trip History</h2>
        </div>
        <div style="overflow-x: auto;">
          <table id="tripsTable">
            <thead>
              <tr>
                <th>Month/Year</th>
                <th>Total Trips</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Partner Modal -->
  <div class="modal" id="partnerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="partnerModalTitle">Add Partner</h3>
        <button class="close-btn" id="closePartnerModal"><i class="bx bx-x"></i></button>
      </div>
      <form id="partnerForm">
        <input type="hidden" id="partnerId">
        <div class="form-group">
          <label>Provider Name *</label>
          <input type="text" id="provider" required>
        </div>
        <div class="form-group">
          <label>Contact *</label>
          <input type="text" id="contact" required>
        </div>
        <div class="form-group">
          <label>Service Area *</label>
          <input type="text" id="serviceArea" required>
        </div>
        <div class="form-group">
          <label>Status *</label>
          <select id="status" required>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Save Partner</button>
      </form>
    </div>
  </div>

  <!-- Driver Modal -->
  <div class="modal" id="driverModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="driverModalTitle">Add Driver</h3>
        <button class="close-btn" id="closeDriverModal"><i class="bx bx-x"></i></button>
      </div>
      <form id="driverForm">
        <input type="hidden" id="driverId">
        <input type="hidden" id="driverLogisticsId">
        <div class="form-group">
          <label>Logistics Partner *</label>
          <select id="driverPartner" required></select>
        </div>
        <div class="form-group">
          <label>Driver Name *</label>
          <input type="text" id="driverName" required>
        </div>
        <div class="form-group">
          <label>Vehicle Type *</label>
          <input type="text" id="vehicleType" required>
        </div>
        <div class="form-group">
          <label>Vehicle Number *</label>
          <input type="text" id="vehicleNumber" required>
        </div>
        <div class="form-group">
          <label>Vehicle Category *</label>
          <select id="vehicleCategory" required>
            <option value="">Select Category</option>
            <option value="Bus">Bus</option>
            <option value="Truck">Truck</option>
            <option value="Van">Van</option>
          </select>
        </div>
        <div class="form-group">
          <label>Phone *</label>
          <input type="text" id="driverPhone" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Save Driver</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="config.js"></script>
  <script>
    // API configuration
    const API_BASE = window.BASE_URL + '/logistics';
    const token = localStorage.getItem('token');

    let logisticsData = [];
    let monthlyTripsData = [];

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // Modal handlers
    const partnerModal = document.getElementById('partnerModal');
    const driverModal = document.getElementById('driverModal');

    document.getElementById('addPartnerBtn').addEventListener('click', () => {
      document.getElementById('partnerForm').reset();
      document.getElementById('partnerId').value = '';
      document.getElementById('partnerModalTitle').textContent = 'Add Partner';
      partnerModal.classList.add('active');
    });

    document.getElementById('addDriverBtn').addEventListener('click', () => {
      document.getElementById('driverForm').reset();
      document.getElementById('driverId').value = '';
      document.getElementById('driverModalTitle').textContent = 'Add Driver';
      populatePartnerSelect();
      driverModal.classList.add('active');
    });

    document.getElementById('closePartnerModal').addEventListener('click', () => {
      partnerModal.classList.remove('active');
    });

    document.getElementById('closeDriverModal').addEventListener('click', () => {
      driverModal.classList.remove('active');
    });

    window.addEventListener('click', (e) => {
      if (e.target === partnerModal) partnerModal.classList.remove('active');
      if (e.target === driverModal) driverModal.classList.remove('active');
    });

    // Generate Service ID
    function generateServiceId() {
      const maxId = logisticsData.reduce((max, item) => {
        const num = parseInt(item.serviceId?.replace('LOG-', '') || '0');
        return num > max ? num : max;
      }, 0);
      return `LOG-${String(maxId + 1).padStart(3, '0')}`;
    }

    // Populate partner select
    function populatePartnerSelect() {
      const select = document.getElementById('driverPartner');
      select.innerHTML = '<option value="">Select Partner</option>';
      logisticsData.forEach(partner => {
        select.innerHTML += `<option value="${partner._id}">${partner.provider} (${partner.serviceId})</option>`;
      });
    }

    // Fetch data
    async function fetchLogistics() {
      try {
        const res = await fetch(API_BASE, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Failed to fetch logistics');
        
        logisticsData = await res.json();
        logisticsData = logisticsData.map(item => ({
          ...item,
          drivers: item.drivers || []
        }));
        
        renderLogisticsTable();
        renderDriversTable();
      } catch (e) {
        console.error('Failed to fetch logistics:', e);
        alert('Failed to load logistics data. Please check your connection.');
      }
    }

    async function fetchAnalytics() {
      try {
        const [logisticsRes, driversRes, tripsRes] = await Promise.all([
          fetch(`${API_BASE}/analytics/logistics`, { headers: { 'Authorization': `Bearer ${token}` } }),
          fetch(`${API_BASE}/analytics/drivers`, { headers: { 'Authorization': `Bearer ${token}` } }),
          fetch(`${API_BASE}/analytics/monthly-trips`, { headers: { 'Authorization': `Bearer ${token}` } })
        ]);

        if (!logisticsRes.ok || !driversRes.ok || !tripsRes.ok) {
          throw new Error('Failed to fetch analytics');
        }

        const logisticsAnalytics = await logisticsRes.json();
        const driversAnalytics = await driversRes.json();
        monthlyTripsData = await tripsRes.json();

        updateAnalytics(logisticsAnalytics, driversAnalytics, monthlyTripsData);
      } catch (e) {
        console.error('Failed to fetch analytics:', e);
        // Set default values on error
        updateAnalytics(
          { totalPartners: 0 },
          { totalDrivers: 0, availableDrivers: 0 },
          []
        );
      }
    }

    function updateAnalytics(logistics, drivers, trips) {
      // Update stats cards
      document.getElementById('totalPartners').textContent = logisticsData.length || 0;
      
      // Calculate total drivers from logistics data
      const totalDrivers = logisticsData.reduce((sum, partner) => 
        sum + (partner.drivers?.length || 0), 0
      );
      document.getElementById('totalDrivers').textContent = totalDrivers;
      
      // Calculate available drivers
      let availableCount = 0;
      logisticsData.forEach(partner => {
        if (partner.drivers) {
          availableCount += partner.drivers.filter(d => d.availability === 'Available').length;
        }
      });
      document.getElementById('availableDrivers').textContent = availableCount;
      
      // Calculate total trips
      const totalTrips = Array.isArray(trips) 
        ? trips.reduce((sum, trip) => sum + (trip.totalTrips || 0), 0)
        : 0;
      document.getElementById('totalTrips').textContent = totalTrips;

      renderTripsChart(trips);
      renderTripsTable(trips);
    }

    function renderTripsChart(data) {
      const ctx = document.getElementById('tripsChart');
      const labels = data.map(d => {
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return `${monthNames[d._id.month - 1]} ${d._id.year}`;
      });
      const values = data.map(d => d.totalTrips);

      if (window.tripsChartInstance) {
        window.tripsChartInstance.destroy();
      }

      window.tripsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Trips',
            data: values,
            backgroundColor: '#3b82f6',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function renderTripsTable(data) {
      const tbody = document.querySelector('#tripsTable tbody');
      tbody.innerHTML = '';

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty-state"><i class="bx bx-trip"></i><p>No trip data available</p></td></tr>';
        return;
      }

      data.sort((a, b) => {
        if (a._id.year !== b._id.year) return b._id.year - a._id.year;
        return b._id.month - a._id.month;
      });

      data.forEach(trip => {
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const row = `
          <tr>
            <td>${monthNames[trip._id.month - 1]} ${trip._id.year}</td>
            <td>${trip.totalTrips}</td>
            <td><span class="badge badge-success">Completed</span></td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    function renderLogisticsTable() {
      const tbody = document.querySelector('#logisticsTable tbody');
      tbody.innerHTML = '';

      if (logisticsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="bx bx-buildings"></i><p>No logistics partners found</p></td></tr>';
        return;
      }

      logisticsData.forEach(partner => {
        const statusBadge = partner.status === 'Active' ? 'badge-success' : 'badge-danger';
        const row = `
          <tr>
            <td>${partner.serviceId}</td>
            <td>${partner.provider}</td>
            <td>${partner.contact}</td>
            <td>${partner.serviceArea}</td>
            <td>${partner.drivers?.length || 0}</td>
            <td><span class="badge ${statusBadge}">${partner.status}</span></td>
            <td>
              <button class="btn btn-success btn-sm" onclick="editPartner('${partner._id}')">
                <i class="bx bx-edit"></i> Edit
              </button>
              <button class="btn btn-danger btn-sm" onclick="deletePartner('${partner._id}')">
                <i class="bx bx-trash"></i> Delete
              </button>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    function renderDriversTable() {
      const tbody = document.querySelector('#driversTable tbody');
      tbody.innerHTML = '';

      const allDrivers = [];
      logisticsData.forEach(partner => {
        if (partner.drivers && partner.drivers.length > 0) {
          partner.drivers.forEach(driver => {
            allDrivers.push({ ...driver, partnerName: partner.provider, partnerId: partner._id });
          });
        }
      });

      if (allDrivers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="bx bx-car"></i><p>No drivers found</p></td></tr>';
        return;
      }

      allDrivers.forEach(driver => {
        const statusBadge = driver.status === 'Active' ? 'badge-success' : 'badge-danger';
        const availBadge = driver.availability === 'Available' ? 'badge-success' : 'badge-warning';
        const row = `
          <tr>
            <td>${driver.name}</td>
            <td>${driver.partnerName}</td>
            <td>${driver.vehicleCategory} ${driver.vehicleType} (${driver.vehicleNumber})</td>
            <td>${driver.phone}</td>
            <td><span class="badge ${statusBadge}">${driver.status}</span></td>
            <td><span class="badge ${availBadge}">${driver.availability}</span></td>
            <td>
              <button class="btn btn-warning btn-sm" onclick="toggleAvailability('${driver.partnerId}', '${driver._id}', '${driver.availability}')">
                <i class="bx bx-refresh"></i> Toggle
              </button>
              <button class="btn btn-success btn-sm" onclick="editDriver('${driver.partnerId}', '${driver._id}')">
                <i class="bx bx-edit"></i>
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteDriver('${driver.partnerId}', '${driver._id}')">
                <i class="bx bx-trash"></i>
              </button>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    // Partner form submit
    document.getElementById('partnerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const partnerId = document.getElementById('partnerId').value;
      const data = {
        provider: document.getElementById('provider').value,
        contact: document.getElementById('contact').value,
        serviceArea: document.getElementById('serviceArea').value,
        status: document.getElementById('status').value
      };

      if (!partnerId) {
        data.serviceId = generateServiceId();
      }

      try {
        const url = partnerId ? `${API_BASE}/${partnerId}` : API_BASE;
        const method = partnerId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });

        if (!res.ok) throw new Error('Failed to save partner');
        
        alert(`Partner ${partnerId ? 'updated' : 'added'} successfully!`);
        partnerModal.classList.remove('active');
        await fetchLogistics();
        await fetchAnalytics();
      } catch (e) {
        alert('Failed to save partner: ' + e.message);
      }
    });

    // Driver form submit
    document.getElementById('driverForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const driverId = document.getElementById('driverId').value;
      const logisticsId = document.getElementById('driverLogisticsId').value || document.getElementById('driverPartner').value;
      
      const data = {
        name: document.getElementById('driverName').value,
        vehicleType: document.getElementById('vehicleType').value,
        vehicleNumber: document.getElementById('vehicleNumber').value,
        vehicleCategory: document.getElementById('vehicleCategory').value,
        phone: document.getElementById('driverPhone').value,
        status: 'Active',
        availability: 'Available'
      };

      try {
        const url = driverId 
          ? `${API_BASE}/${logisticsId}/drivers/${driverId}`
          : `${API_BASE}/${logisticsId}/drivers`;
        const method = driverId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });

        if (!res.ok) throw new Error('Failed to save driver');
        
        alert(`Driver ${driverId ? 'updated' : 'added'} successfully!`);
        driverModal.classList.remove('active');
        await fetchLogistics();
        await fetchAnalytics();
      } catch (e) {
        alert('Failed to save driver: ' + e.message);
      }
    });

    // CRUD operations
    window.editPartner = (id) => {
      const partner = logisticsData.find(p => p._id === id);
      if (partner) {
        document.getElementById('partnerId').value = partner._id;
        document.getElementById('provider').value = partner.provider;
        document.getElementById('contact').value = partner.contact;
        document.getElementById('serviceArea').value = partner.serviceArea;
        document.getElementById('status').value = partner.status;
        document.getElementById('partnerModalTitle').textContent = 'Edit Partner';
        partnerModal.classList.add('active');
      }
    };

    window.deletePartner = async (id) => {
      if (!confirm('Are you sure you want to delete this partner?')) return;
      
      try {
        const res = await fetch(`${API_BASE}/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to delete');
        
        alert('Partner deleted successfully!');
        await fetchLogistics();
        await fetchAnalytics();
      } catch (e) {
        alert('Failed to delete partner: ' + e.message);
      }
    };

    window.editDriver = (partnerId, driverId) => {
      const partner = logisticsData.find(p => p._id === partnerId);
      const driver = partner?.drivers.find(d => d._id === driverId);
      
      if (driver) {
        document.getElementById('driverId').value = driver._id;
        document.getElementById('driverLogisticsId').value = partnerId;
        document.getElementById('driverName').value = driver.name;
        document.getElementById('vehicleType').value = driver.vehicleType;
        document.getElementById('vehicleNumber').value = driver.vehicleNumber;
        document.getElementById('vehicleCategory').value = driver.vehicleCategory;
        document.getElementById('driverPhone').value = driver.phone;
        document.getElementById('driverPartner').value = partnerId;
        document.getElementById('driverModalTitle').textContent = 'Edit Driver';
        populatePartnerSelect();
        driverModal.classList.add('active');
      }
    };

    window.deleteDriver = async (partnerId, driverId) => {
      if (!confirm('Are you sure you want to delete this driver?')) return;
      
      try {
        const res = await fetch(`${API_BASE}/${partnerId}/drivers/${driverId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to delete');
        
        alert('Driver deleted successfully!');
        await fetchLogistics();
        await fetchAnalytics();
      } catch (e) {
        alert('Failed to delete driver: ' + e.message);
      }
    };

    window.toggleAvailability = async (partnerId, driverId, currentAvailability) => {
      const newAvailability = currentAvailability === 'Available' ? 'On Trip' : 'Available';
      
      try {
        const res = await fetch(`${API_BASE}/${partnerId}/drivers/${driverId}/availability`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ availability: newAvailability })
        });

        if (!res.ok) throw new Error('Failed to update');
        
        alert(`Driver availability updated to: ${newAvailability}`);
        await fetchLogistics();
        await fetchAnalytics();
      } catch (e) {
        alert('Failed to update availability: ' + e.message);
      }
    };

    // Initialize
    async function init() {
      await fetchLogistics();
      await fetchAnalytics();
    }

    init();
  </script>
</body>
</html>