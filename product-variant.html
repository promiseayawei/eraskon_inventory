<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Variant Manager</title>

  <!-- Icons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Vue.js & Axios -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- Meta Manager -->
  <script src="assets/js/metaManager.js"></script>
  <script>
    setMeta({
      title: "Eraskon | Product Variant",
      desc: "Access the Eraskon Inventory portal to manage product variants.",
      image: "assets/images/eraskon_logo.webp",
      favicon: "assets/images/eraskon_logo.webp",
      keywords: "Inventory, Warehouse, Stock, Sales, Product Variant"
    });
  </script>

  <style>
    :root {
      --bg-color: #e2dcdc;
      --text-color: #090F3B;
      --card-bg: #ffffff;
      --border-color: #ccc;
      --input-border: #ccc;
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --danger-color: #ef4444;
      --danger-hover: #dc2626;
      --secondary-color: #6b7280;
      --secondary-hover: #4b5563;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding-top: 75px;
      padding-left: 90px;
      transition: padding-left 0.3s ease;
      min-height: 100vh;
    }

    /* Navbar Styling - Consistent with Chairman's View */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 75px;
      background-color: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      z-index: 1000;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .navbar-brand img {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      color: #10b981;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      background-color: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--secondary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .user-avatar:hover {
      transform: scale(1.05);
    }

    .user-avatar i {
      font-size: 1.25rem;
    }

    /* Sidebar Positioning */
    .sidebar {
      margin-top: 0;
      height: calc(100% - 75px);
      top: 75px;
      z-index: 999;
    }

    /* Main Content */
    #app {
      padding: 20px;
      max-width: 1600px;
    }

    h1 {
      margin: 0 0 20px 0;
      font-size: 2rem;
      font-weight: 600;
      color: var(--text-color);
    }

    /* Responsive adjustments */
    @media(max-width: 768px) {
      body {
        padding-left: 20px !important;
      }

      .navbar {
        padding: 0 15px;
      }

      .navbar-brand {
        font-size: 1rem;
      }

      .navbar-brand img {
        width: 32px;
        height: 32px;
      }

      h1 {
        font-size: 1.5rem;
      }
    }

    /* Table */
    .table-wrapper {
      overflow-x: auto;
      margin-top: 20px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--card-bg);
      color: var(--text-color);
    }

    th,
    td {
      padding: 12px 15px;
      text-align: left;
      white-space: nowrap;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: var(--text-color);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.5px;
    }

    tbody tr {
      transition: background-color 0.2s;
    }

    tbody tr:hover {
      background-color: #f8f9fa;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    /* Buttons */
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: var(--primary-color);
      color: white;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: var(--secondary-color);
    }

    .btn-secondary:hover {
      background: var(--secondary-hover);
      box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
    }

    .btn-danger {
      background: var(--danger-color);
    }

    .btn-danger:hover {
      background: var(--danger-hover);
      box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 0.8em;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      width: 95%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideIn 0.3s ease;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal h2 {
      margin: 0 0 20px 0;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-color);
    }

    /* Cards */
    .card-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--card-bg);
      padding: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .card-image {
      width: 100%;
      height: 150px;
      object-fit: contain;
      margin-bottom: 15px;
      border-radius: 8px;
      background: #f8f9fa;
    }

    .card h3 {
      margin: 0 0 12px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .card p {
      margin: 8px 0;
      font-size: 0.9em;
      color: #6b7280;
    }

    .card p strong {
      color: var(--text-color);
      font-weight: 600;
    }

    .card-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    /* Forms */
    label {
      display: block;
      font-weight: 600;
      margin-top: 15px;
      margin-bottom: 5px;
      color: var(--text-color);
      font-size: 0.9rem;
    }

    input,
    select {
      width: 100%;
      padding: 10px 12px;
      margin-top: 4px;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      background-color: var(--card-bg);
      color: var(--text-color);
      font-size: 0.95rem;
      transition: border-color 0.3s;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    input[type="checkbox"] {
      width: auto;
      margin-right: 6px;
    }

    .preview {
      max-width: 150px;
      max-height: 150px;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      object-fit: contain;
    }

    .inline-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .error {
      color: var(--danger-color);
      font-size: 0.85em;
      margin-top: 4px;
      display: block;
      font-weight: 500;
    }

    .form-error-banner {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .success-message {
      background: #d1fae5;
      border: 1px solid #6ee7b7;
      color: #065f46;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-section {
      margin-top: 25px;
      padding: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: #f8f9fa;
    }

    .form-section h3 {
      margin: 0 0 15px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .batch-item,
    .warehouse-item {
      border: 2px dashed var(--border-color);
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background: white;
    }

    .header-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-actions {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 10px;
    }

    /* Loading State */
    .loading {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-state i {
      font-size: 4rem;
      color: #d1d5db;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      margin: 0 0 10px 0;
      font-size: 1.25rem;
      color: var(--text-color);
    }

    .empty-state p {
      margin: 0;
      font-size: 0.95rem;
    }
  </style>
</head>

<body>
 
  <script src="components/uiComponents.js"></script>
  <script src="components/spinner.js"></script>
  <script src="components/authGuard.js"></script>
  <script src="components/navbar.js"></script>
  <script src="components/sidebar.js"></script>

  <main id="app">
    <h1>Product Variant Manager</h1>

    <div v-if="successMessage" class="success-message">
      <i class="fas fa-check-circle"></i> {{ successMessage }}
    </div>

    <div class="header-actions">
      <div class="action-buttons">
        <button @click="showAddModal()">
          <i class="fas fa-plus-circle"></i> Add New Variant
        </button>
        <button @click="toggleView()" class="btn-secondary">
          <i :class="view==='table'?'fas fa-grip-horizontal':'fas fa-table'"></i>
          Switch to {{ view==='table'?'Card':'Table' }} View
        </button>
      </div>
    </div>

    <!-- Table View -->
    <div v-if="view==='table'">
      <div v-if="productVariants.length === 0" class="empty-state">
        <i class="fas fa-box-open"></i>
        <h3>No Product Variants Yet</h3>
        <p>Click "Add New Variant" to create your first product variant.</p>
      </div>
      <div v-else class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>Product</th>
              <th>SKU</th>
              <th>Barcode</th>
              <th>Selling Price</th>
              <th>Cost Price</th>
              <th>Total Stock</th>
              <th>Batch Tracking</th>
              <th>Low Stock</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="variant in productVariants" :key="variant._id">
              <td>
                <img v-if="variant.image" :src="variant.image" style="max-width:50px;max-height:50px;border-radius:4px;" />
                <i v-else class="fas fa-image" style="font-size:2rem;color:#d1d5db;"></i>
              </td>
              <td><strong>{{ variant.name }}</strong></td>
              <td>{{ variant.product?.name || 'N/A' }}</td>
              <td><code>{{ variant.sku }}</code></td>
              <td>{{ variant.barcode || '-' }}</td>
              <td><strong>₦{{ Number(variant.price || 0).toLocaleString('en-NG', {minimumFractionDigits: 2}) }}</strong></td>
              <td>₦{{ Number(variant.costPrice || 0).toLocaleString('en-NG', {minimumFractionDigits: 2}) }}</td>
              <td><strong>{{ variant.totalStock }}</strong></td>
              <td>
                <span v-if="variant.batchTracking" style="color:#10b981;">
                  <i class="fas fa-check-circle"></i> Yes
                </span>
                <span v-else style="color:#6b7280;">
                  <i class="fas fa-times-circle"></i> No
                </span>
              </td>
              <td>{{ variant.lowStockThreshold || 0 }}</td>
              <td>
                <span v-if="variant.active" style="color:#10b981;font-weight:600;">
                  <i class="fas fa-circle" style="font-size:0.5rem;"></i> Active
                </span>
                <span v-else style="color:#ef4444;font-weight:600;">
                  <i class="fas fa-circle" style="font-size:0.5rem;"></i> Inactive
                </span>
              </td>
              <td>
                <div style="display:flex; gap:5px;">
                  <button @click="showEditModal(variant)" class="btn-small">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button @click="deleteVariant(variant._id)" class="btn-danger btn-small">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Card View -->
    <div v-else>
      <div v-if="productVariants.length === 0" class="empty-state">
        <i class="fas fa-box-open"></i>
        <h3>No Product Variants Yet</h3>
        <p>Click "Add New Variant" to create your first product variant.</p>
      </div>
      <div v-else class="card-container">
        <div v-for="variant in productVariants" :key="variant._id" class="card">
          <img v-if="variant.image" :src="variant.image" class="card-image" />
          <div v-else style="width:100%;height:150px;background:#f8f9fa;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:15px;">
            <i class="fas fa-image" style="font-size:3rem;color:#d1d5db;"></i>
          </div>
          <h3>{{ variant.name }}</h3>
          <p><strong>Product:</strong> {{ variant.product?.name || 'N/A' }}</p>
          <p><strong>SKU:</strong> <code>{{ variant.sku }}</code></p>
          <p><strong>Barcode:</strong> {{ variant.barcode || '-' }}</p>
          <p><strong>Selling Price:</strong> ₦{{ Number(variant.price || 0).toLocaleString('en-NG', {minimumFractionDigits: 2}) }}</p>
          <p><strong>Cost Price:</strong> ₦{{ Number(variant.costPrice || 0).toLocaleString('en-NG', {minimumFractionDigits: 2}) }}</p>
          <p><strong>Total Stock:</strong> {{ variant.totalStock }}</p>
          <p><strong>Batch Tracking:</strong> {{ variant.batchTracking?'Yes':'No' }}</p>
          <p><strong>Low Stock Threshold:</strong> {{ variant.lowStockThreshold || 0 }}</p>
          <p>
            <strong>Status:</strong>
            <span v-if="variant.active" style="color:#10b981;font-weight:600;">Active</span>
            <span v-else style="color:#ef4444;font-weight:600;">Inactive</span>
          </p>
          <div class="card-actions">
            <button @click="showEditModal(variant)" style="flex:1;">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button @click="deleteVariant(variant._id)" class="btn-danger" style="flex:1;">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div v-if="modalVisible" class="modal-overlay" @click.self="closeModal()">
      <div class="modal" @click.stop>
        <h2>
          <i :class="editingVariant?'fas fa-edit':'fas fa-plus-circle'"></i>
          {{ editingVariant?'Edit':'Add' }} Product Variant
        </h2>
        
        <div v-if="formError" class="form-error-banner">
          <i class="fas fa-exclamation-triangle"></i> {{ formError }}
        </div>

        <form @submit.prevent="onSubmit">
          <div class="inline-row">
            <div>
              <label for="product">Product *</label>
              <select id="product" v-model="form.product" required>
                <option value="">Select a Product</option>
                <option v-for="product in products" :key="product._id" :value="product._id">{{ product.name }}</option>
              </select>
              <span v-if="errors.product" class="error">{{ errors.product }}</span>
            </div>
            <div>
              <label for="name">Variant Name *</label>
              <input type="text" id="name" v-model="form.name" required placeholder="e.g. Gold 10 Litres">
              <span v-if="errors.name" class="error">{{ errors.name }}</span>
            </div>
          </div>

          <div class="inline-row">
            <div>
              <label for="sku">SKU *</label>
              <input type="text" id="sku" v-model="form.sku" required placeholder="e.g. SKU-G002">
              <span v-if="errors.sku" class="error">{{ errors.sku }}</span>
            </div>
            <div>
              <label for="barcode">Barcode</label>
              <input type="text" id="barcode" v-model="form.barcode" placeholder="Optional">
              <span v-if="errors.barcode" class="error">{{ errors.barcode }}</span>
            </div>
          </div>

          <div class="inline-row">
            <div>
              <label for="price">Selling Price (₦) *</label>
              <input type="number" id="price" v-model.number="form.price" required min="0" step="0.01" placeholder="0.00">
              <span v-if="errors.price" class="error">{{ errors.price }}</span>
            </div>
            <div>
              <label for="costPrice">Cost Price (₦) *</label>
              <input type="number" id="costPrice" v-model.number="form.costPrice" required min="0" step="0.01" placeholder="0.00">
              <span v-if="errors.costPrice" class="error">{{ errors.costPrice }}</span>
            </div>
          </div>

          <div class="inline-row">
            <div>
              <label for="lowStockThreshold">Low Stock Threshold</label>
              <input type="number" id="lowStockThreshold" v-model.number="form.lowStockThreshold" min="0" placeholder="0">
              <span v-if="errors.lowStockThreshold" class="error">{{ errors.lowStockThreshold }}</span>
            </div>
            <div style="display:flex; align-items:flex-end; gap:20px; padding-top:10px;">
              <div>
                <input type="checkbox" id="batchTracking" v-model="form.batchTracking">
                <label for="batchTracking" style="display:inline; font-weight:normal; margin:0;">Enable Batch Tracking</label>
              </div>
              <div>
                <input type="checkbox" id="active" v-model="form.active">
                <label for="active" style="display:inline; font-weight:normal; margin:0;">Active</label>
              </div>
            </div>
          </div>

          <div class="form-section">
            <label for="imageUpload">Product Image</label>
            <input type="file" id="imageUpload" @change="onImageChange" accept="image/*">
            <img v-if="previewImage || form.image" :src="previewImage || form.image" class="preview" alt="Image Preview" />
            <button type="button" v-if="form.image && !previewImage" @click="removeImage()" class="btn-danger btn-small" style="margin-top: 10px;">
              <i class="fas fa-trash"></i> Remove Current Image
            </button>
            <span v-if="errors.image" class="error">{{ errors.image }}</span>
          </div>

          <div v-if="form.batchTracking" class="form-section">
            <h3><i class="fas fa-boxes"></i> Batch Information</h3>
            <div v-for="(batch, index) in form.batches" :key="index" class="batch-item">
              <div class="inline-row">
                <div>
                  <label :for="'batchNumber'+index">Batch Number *</label>
                  <input type="text" :id="'batchNumber'+index" v-model="batch.batchNumber" required placeholder="e.g. BATCH001">
                </div>
                <div>
                  <label :for="'expiryDate'+index">Expiry Date</label>
                  <input type="date" :id="'expiryDate'+index" v-model="batch.expiryDate">
                </div>
              </div>
              <div class="inline-row">
                <div>
                  <label :for="'batchQuantity'+index">Quantity *</label>
                  <input type="number" :id="'batchQuantity'+index" v-model.number="batch.quantity" required min="0" placeholder="0">
                </div>
                <div>
                  <label :for="'batchWarehouse'+index">Warehouse *</label>
                  <select :id="'batchWarehouse'+index" v-model="batch.warehouse" required>
                    <option value="">Select Warehouse</option>
                    <option v-for="wh in warehouses" :key="wh._id" :value="wh._id">{{ wh.name }}</option>
                  </select>
                </div>
              </div>
              <button type="button" @click="removeBatch(index)" class="btn-danger btn-small" style="margin-top: 10px;">
                <i class="fas fa-times"></i> Remove Batch
              </button>
            </div>
            <button type="button" @click="addBatch()" class="btn-secondary btn-small">
              <i class="fas fa-plus"></i> Add Another Batch
            </button>
          </div>

          <div v-if="!form.batchTracking" class="form-section">
            <h3><i class="fas fa-warehouse"></i> Warehouse Stock (Total: {{ totalStock }})</h3>
            <div v-for="(whStock, index) in form.warehouses" :key="index" class="warehouse-item">
              <div class="inline-row">
                <div>
                  <label :for="'warehouse'+index">Warehouse *</label>
                  <select :id="'warehouse'+index" v-model="whStock.warehouse" required>
                    <option value="">Select Warehouse</option>
                    <option v-for="wh in availableWarehouses(whStock.warehouse)" :key="wh._id" :value="wh._id">{{ wh.name }}</option>
                  </select>
                </div>
                <div>
                  <label :for="'stock'+index">Stock Quantity *</label>
                  <input type="number" :id="'stock'+index" v-model.number="whStock.stock" required min="0" placeholder="0">
                </div>
              </div>
              <button type="button" @click="removeWarehouseStock(index)" class="btn-danger btn-small" style="margin-top: 10px;">
                <i class="fas fa-times"></i> Remove Warehouse
              </button>
            </div>
            <button type="button" @click="addWarehouseStock()" class="btn-secondary btn-small" :disabled="form.warehouses.length >= warehouses.length">
              <i class="fas fa-plus"></i> Add Warehouse Stock
            </button>
            <span v-if="form.warehouses.length >= warehouses.length" class="error">All warehouses have been assigned.</span>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn" :disabled="isSubmitting">
              <span v-if="!isSubmitting">
                <i class="fas fa-save"></i> Save Variant
              </span>
              <span v-else>
                <span class="loading"></span> Saving...
              </span>
            </button>
            <button type="button" @click="closeModal()" class="btn-secondary" :disabled="isSubmitting">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script src="config.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      const sidebarOpen = document.getElementById('sidebarOpen');
      const isCollapsed = localStorage.getItem('sidebarState') === 'close';
      document.body.style.paddingLeft = isCollapsed ? '90px' : '280px';

      if (sidebarOpen && sidebar) {
        sidebarOpen.addEventListener('click', () => {
          sidebar.classList.toggle('close');
          const closed = sidebar.classList.contains('close');
          localStorage.setItem('sidebarState', closed ? 'close' : 'open');
          document.body.style.paddingLeft = closed ? '90px' : '280px';
        });
      }
    });

    const API_BASE = window.BASE_URL || '/api';

    new Vue({
      el: '#app',
      data: {
        productVariants: [],
        products: [],
        warehouses: [],
        view: 'table',
        modalVisible: false,
        editingVariant: null,
        previewImage: null,
        formError: '',
        successMessage: '',
        isSubmitting: false,
        form: {
          _id: '',
          product: '',
          name: '',
          sku: '',
          barcode: '',
          price: 0,
          costPrice: 0,
          batchTracking: false,
          lowStockThreshold: 0,
          active: true,
          image: null,
          imageFile: null,
          batches: [],
          warehouses: []
        },
        errors: {}
      },
      mounted() {
        this.fetchVariants();
        this.fetchProducts();
        this.fetchWarehouses();
      },
      computed: {
        totalStock() {
          if (this.form.batchTracking) {
            return this.form.batches.reduce((sum, b) => sum + (Number(b.quantity) || 0), 0);
          }
          return this.form.warehouses.reduce((sum, w) => sum + (Number(w.stock) || 0), 0);
        }
      },
      watch: {
        'form.batchTracking': function(newVal, oldVal) {
          if (newVal && !oldVal) {
            if (this.form.batches.length === 0) {
              this.addBatch();
            }
          }
        }
      },
      methods: {
        toggleView() {
          this.view = this.view === 'table' ? 'card' : 'table';
        },

        showAddModal() {
          this.resetForm();
          this.editingVariant = null;
          this.modalVisible = true;
        },

        showEditModal(variant) {
          this.editingVariant = variant;
          const v = JSON.parse(JSON.stringify(variant));

          this.errors = {};
          this.formError = '';
          this.previewImage = null;

          this.form._id = v._id;
          this.form.product = v.product?._id || v.product || '';
          this.form.name = v.name || '';
          this.form.sku = v.sku || '';
          this.form.barcode = v.barcode || '';
          this.form.price = Number(v.price) || 0;
          this.form.costPrice = Number(v.costPrice) || 0;
          this.form.batchTracking = Boolean(v.batchTracking);
          this.form.lowStockThreshold = Number(v.lowStockThreshold) || 0;
          this.form.active = v.active !== false;
          this.form.image = v.image || null;
          this.form.imageFile = null;

          this.form.batches = (v.batches || []).map(b => ({
            batchNumber: b.batchNumber || '',
            expiryDate: b.expiryDate ? new Date(b.expiryDate).toISOString().split('T')[0] : '',
            quantity: Number(b.quantity) || 0,
            warehouse: b.warehouse?._id || b.warehouse || ''
          }));

          this.form.warehouses = (v.warehouses || []).map(w => ({
            warehouse: w.warehouse?._id || w.warehouse || '',
            stock: Number(w.stock) || 0
          }));

          this.$nextTick(() => {
            this.modalVisible = true;
          });
        },

        closeModal() {
          this.modalVisible = false;
          setTimeout(() => {
            this.resetForm();
            this.editingVariant = null;
          }, 300);
        },

        resetForm() {
          this.form = {
            _id: '',
            product: '',
            name: '',
            sku: '',
            barcode: '',
            price: 0,
            costPrice: 0,
            batchTracking: false,
            lowStockThreshold: 0,
            active: true,
            image: null,
            imageFile: null,
            batches: [],
            warehouses: []
          };
          this.previewImage = null;
          this.errors = {};
          this.formError = '';
          const fileInput = document.getElementById('imageUpload');
          if (fileInput) fileInput.value = null;
        },

        async fetchVariants() {
          try {
            const res = await axios.get(`${API_BASE}/product-variant`);
            this.productVariants = res.data;
            console.log('Variants loaded:', this.productVariants.length);
          } catch (e) {
            this.showError('Failed to load product variants');
            console.error('Error loading variants:', e);
          }
        },

        async fetchProducts() {
          try {
            const res = await axios.get(`${API_BASE}/products`);
            this.products = res.data;
          } catch (e) {
            this.showError('Failed to load products');
            console.error(e);
          }
        },

        async fetchWarehouses() {
          try {
            const res = await axios.get(`${API_BASE}/warehouse`);
            this.warehouses = res.data;
          } catch (e) {
            this.showError('Failed to load warehouses');
            console.error(e);
          }
        },

        async onSubmit() {
          this.errors = {};
          this.formError = '';
          this.isSubmitting = true;

          // Validation
          if (!this.form.product) this.errors.product = 'Product is required';
          if (!this.form.name) this.errors.name = 'Variant name is required';
          if (!this.form.sku) this.errors.sku = 'SKU is required';
          if (!this.form.price || this.form.price <= 0) this.errors.price = 'Price must be greater than 0';
          if (!this.form.costPrice || this.form.costPrice <= 0) this.errors.costPrice = 'Cost price must be greater than 0';

          if (this.form.batchTracking && this.form.batches.length === 0) {
            this.formError = 'Please add at least one batch when batch tracking is enabled';
            this.isSubmitting = false;
            return;
          }

          if (!this.form.batchTracking && this.form.warehouses.length === 0) {
            this.formError = 'Please add at least one warehouse stock entry';
            this.isSubmitting = false;
            return;
          }

          if (Object.keys(this.errors).length > 0) {
            this.formError = 'Please fix the errors below';
            this.isSubmitting = false;
            return;
          }

          try {
            const formData = new FormData();

            if (this.form.imageFile) {
              formData.append('image', this.form.imageFile);
            }

            formData.append('product', this.form.product);
            formData.append('name', this.form.name);
            formData.append('sku', this.form.sku);
            formData.append('barcode', this.form.barcode || '');
            formData.append('price', this.form.price);
            formData.append('costPrice', this.form.costPrice);
            formData.append('batchTracking', this.form.batchTracking);
            formData.append('lowStockThreshold', this.form.lowStockThreshold || 0);
            formData.append('active', this.form.active);

            if (this.form.batchTracking) {
              formData.append('batches', JSON.stringify(this.form.batches));
              formData.append('warehouses', JSON.stringify([]));
            } else {
              formData.append('batches', JSON.stringify([]));
              formData.append('warehouses', JSON.stringify(this.form.warehouses));
            }

            if (this.form.image === 'DELETE') {
              formData.append('imageRemoval', true);
            }

            const config = {
              headers: { 'Content-Type': 'multipart/form-data' }
            };

            if (this.editingVariant) {
              await axios.patch(`${API_BASE}/product-variant/${this.form._id}`, formData, config);
              this.showSuccess('Variant updated successfully');
            } else {
              await axios.post(`${API_BASE}/product-variant`, formData, config);
              this.showSuccess('Variant added successfully');
            }

            this.closeModal();
            await this.fetchVariants();

          } catch (e) {
            this.formError = e.response?.data?.message || e.response?.data?.error || 'Error saving variant';
            console.error('Submit error:', e.response?.data || e.message);
          } finally {
            this.isSubmitting = false;
          }
        },

        async deleteVariant(id) {
          if (!confirm('Are you sure you want to delete this variant? This action cannot be undone.')) return;
          try {
            await axios.delete(`${API_BASE}/product-variant/${id}`);
            this.showSuccess('Variant deleted successfully');
            this.fetchVariants();
          } catch (e) {
            this.showError('Failed to delete variant');
            console.error(e);
          }
        },

        onImageChange(event) {
          const file = event.target.files[0];
          if (!file) {
            this.form.imageFile = null;
            this.previewImage = null;
            return;
          }
          this.form.imageFile = file;
          const reader = new FileReader();
          reader.onload = e => this.previewImage = e.target.result;
          reader.readAsDataURL(file);
        },

        removeImage() {
          this.form.image = 'DELETE';
          this.previewImage = null;
          this.form.imageFile = null;
          const fileInput = document.getElementById('imageUpload');
          if (fileInput) fileInput.value = null;
        },

        addBatch() {
          this.form.batches.push({
            batchNumber: '',
            expiryDate: '',
            quantity: 0,
            warehouse: ''
          });
        },

        removeBatch(i) {
          this.form.batches.splice(i, 1);
        },

        addWarehouseStock() {
          if (this.form.warehouses.length < this.warehouses.length) {
            const assigned = this.form.warehouses.map(w => w.warehouse);
            const first = this.warehouses.find(w => !assigned.includes(w._id));
            if (first) {
              this.form.warehouses.push({
                warehouse: first._id,
                stock: 0
              });
            }
          }
        },

        removeWarehouseStock(i) {
          this.form.warehouses.splice(i, 1);
        },

        availableWarehouses(currentId) {
          const assigned = this.form.warehouses
            .map(w => w.warehouse)
            .filter(id => id !== currentId);
          return this.warehouses.filter(w => !assigned.includes(w._id));
        },

        showError(msg) {
          this.formError = msg;
          setTimeout(() => this.formError = '', 5000);
        },

        showSuccess(msg) {
          this.successMessage = msg;
          setTimeout(() => this.successMessage = '', 5000);
        }
      }
    });
  </script>
</body>

</html>