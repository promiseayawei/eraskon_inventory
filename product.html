<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Product Manager</title>

    <!-- External CSS -->
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script src="assets/js/metaManager.js"></script>
    <script>
        setMeta({
            title: "Eraskon | Product",
            desc: "Access the Eraskon Inventory portal to manage products.",
            image: "assets/images/eraskon_logo.webp",
            favicon: "assets/images/eraskon_logo.webp",
            keywords: "Inventory, Warehouse, Stock, Sales, Product"
        });
    </script>

<style>
:root {
  --bg-color: #e2dcdc;
  --text-color: #090F3B;
  --card-bg: #ffffff;
  --border-color: #ccc;
  --input-border: #ccc;
}

body.dark {
  --bg-color: #090F3B;
  --text-color: #f1f1f1;
  --card-bg: #050d4a;
  --border-color: #444;
  --input-border: #444;
}

body {
  background-color: var(--bg-color);
  color: var(--text-color);
  transition: background-color 0.5s ease, color 0.5s ease;
}

/* Table */
table {
  width: 100%;
  border-collapse: collapse;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
}

th, td {
  padding: 10px;
  border: 1px solid var(--border-color);
}

th { background-color: rgba(0, 0, 0, 0.05); }
body.dark th { background-color: rgba(255, 255, 255, 0.05); }

tr:hover { background-color: rgba(0, 0, 0, 0.03); }
body.dark tr:hover { background-color: rgba(255, 255, 255, 0.06); }

/* Buttons */
button {
  padding: 8px 12px;
  border: none;
  background: #3b82f6;
  color: white;
  border-radius: 6px;
  cursor: pointer;
}
button:hover { background: #2563eb; }

/* Inputs */
input, select, textarea {
  width: 100%;
  padding: 6px 8px;
  margin-top: 4px;
  border: 1px solid var(--input-border);
  border-radius: 4px;
  background: var(--bg-color);
  color: var(--text-color);
}

/* Error */
.error { color: red; font-size: 0.9em; }
</style>
</head>

<body>
    <!-- Components -->
    <script src="components/uiComponents.js"></script>
    <script src="components/spinner.js"></script>
    <script src="components/authGuard.js"></script>
    <script src="components/navbar.js"></script>
    <script src="components/sidebar.js"></script>

<main id="app" class="main-content">
    <h1>Product Manager</h1>

    <!-- PRODUCT FORM -->
    <form @submit.prevent="submitForm">
        <label>Name</label>
        <input type="text" v-model="form.name" required />
        <span class="error" v-if="errors.name">{{ errors.name }}</span>

        <label>Description</label>
        <textarea v-model="form.description" rows="3"></textarea>

        <label>Category</label>
        <select v-model="form.category" required>
            <option disabled value="">-- Select Category --</option>
            <option v-for="cat in categories" :value="cat._id">{{ cat.name }}</option>
        </select>
        <span class="error" v-if="errors.category">{{ errors.category }}</span>

        <button type="submit">{{ form._id ? 'Update' : 'Add' }} Product</button>
        <button type="button" v-if="form._id" @click="resetForm" style="background:#aaa;">Cancel</button>

        <div class="error" v-if="formError">{{ formError }}</div>
    </form>

    <!-- SEARCH + PAGINATION -->
    <div style="margin: 24px 0 12px; display: flex; flex-wrap: wrap; gap: 16px;">
        <input type="text" v-model="search" placeholder="Search products..." style="max-width:260px;" />
        <div style="margin-left:auto;">
            <button :disabled="page === 1" @click="page--">Prev</button>
            <span style="margin: 0 8px;">Page {{ page }} / {{ totalPages }}</span>
            <button :disabled="page === totalPages" @click="page++">Next</button>
        </div>
    </div>

    <!-- PRODUCT TABLE -->
    <table v-if="pagedProducts.length">
        <thead>
            <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Category</th>
                <th style="width:90px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="prod in pagedProducts" :key="prod._id">
                <td>{{ prod.name }}</td>
                <td>{{ prod.description }}</td>
                <td>{{ getCategoryName(prod.category) }}</td>
                <td>
                    <button @click="editProduct(prod)" style="padding:4px 10px;">Edit</button>
                    <button @click="deleteProduct(prod._id)" style="padding:4px 10px;background:#e53e3e;">Delete</button>
                </td>
            </tr>
        </tbody>
    </table>
    <div v-else style="margin-top:32px;color:#888;">No products found.</div>
</main>

<script src="config.js"></script>

<script>
const API_BASE = window.BASE_URL;

new Vue({
    el: '#app',
    data: {
        products: [],
        categories: [],
        form: { _id: '', name: '', description: '', category: '' },
        search: '',
        page: 1,
        perPage: 10,
        errors: {},
        formError: ''
    },
    computed: {
        filteredProducts() {
            const s = this.search.trim().toLowerCase();
            if (!s) return this.products;

            return this.products.filter(p => {
                const catName = this.getCategoryName(p.category).toLowerCase();
                return (
                    (p.name || '').toLowerCase().includes(s) ||
                    (p.description || '').toLowerCase().includes(s) ||
                    catName.includes(s)
                );
            });
        },
        totalPages() {
            return Math.max(1, Math.ceil(this.filteredProducts.length / this.perPage));
        },
        pagedProducts() {
            const start = (this.page - 1) * this.perPage;
            return this.filteredProducts.slice(start, start + this.perPage);
        }
    },
    watch: {
        search() { this.page = 1; },
        filteredProducts() {
            if (this.page > this.totalPages) this.page = this.totalPages;
        }
    },
    mounted() {
        this.fetchProducts();
        this.fetchCategories();
    },
    methods: {
        async fetchProducts() {
            try {
                const res = await axios.get(`${API_BASE}/products`);
                this.products = res.data;
            } catch (err) { console.error(err); }
        },
        async fetchCategories() {
            try {
                const res = await axios.get(`${API_BASE}/category`);
                this.categories = res.data;
            } catch (err) { console.error(err); }
        },
        getCategoryName(cat) {
            if (!cat) return '';
            const id = typeof cat === 'object' ? cat._id : cat;
            const found = this.categories.find(c => c._id === id);
            return found ? found.name : '';
        },
        validateForm() {
            this.errors = {};
            if (!this.form.name.trim()) this.errors.name = "Name is required";
            if (!this.form.category) this.errors.category = "Category is required";
            return Object.keys(this.errors).length === 0;
        },
        async submitForm() {
            if (!this.validateForm()) return;

            try {
                if (this.form._id) {
                    await axios.put(`${API_BASE}/products/${this.form._id}`, this.form);
                } else {
                    await axios.post(`${API_BASE}/products`, this.form);
                }
                this.resetForm();
                this.fetchProducts();
            } catch (err) {
                this.formError = err.response?.data?.message || "Submit failed";
            }
        },
        editProduct(prod) {
            this.form = {
                _id: prod._id,
                name: prod.name,
                description: prod.description,
                category: typeof prod.category === 'object' ? prod.category._id : prod.category
            };
            this.errors = {};
            this.formError = '';
        },
        async deleteProduct(id) {
            if (!confirm("Are you sure?")) return;
            try {
                await axios.delete(`${API_BASE}/products/${id}`);
                this.fetchProducts();
            } catch (err) {
                alert("Delete failed");
            }
        },
        resetForm() {
            this.form = { _id: '', name: '', description: '', category: '' };
            this.errors = {};
            this.formError = '';
        }
    }
});
</script>

</body>
</html>
