<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eraskon Inventory Management - Warehouses</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Excel Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

 
</head>

<body>

  <script src="components/navbar.js"></script>
  <script src="components/sidebar.js"></script>

  <div class="container">
    <h1>Reports</h1>

    <!-- Sales Report -->
    <section>
      <h2 style="margin-top: 1em;">Sales Report</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <input id="salesSearch" type="text" placeholder="Search Sales..." style="padding:6px 12px;border-radius:6px;border:1px solid #ccc;min-width:180px;">
        <div id="salesPagination" style="display:flex;gap:4px;"></div>
      </div>
      <table id="salesReportTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Order Code</th>
            <th>Customer</th>
            <th>Channel</th>
            <th>Status</th>
            <th>Total</th>
            <th>Payment Method</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filled dynamically -->
        </tbody>
        <!-- Sales Report Table Total -->
        <tfoot>
          <tr>
            <td colspan="5" style="text-align:right;font-weight:bold;">Total Sales:</td>
            <td id="salesTotal" style="font-weight:bold;color:#2563eb;"></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </section>

    <!-- Order Report -->
    <section>
      <h2>Order Report</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <input id="orderSearch" type="text" placeholder="Search Orders..." style="padding:6px 12px;border-radius:6px;border:1px solid #ccc;min-width:180px;">
        <div id="orderPagination" style="display:flex;gap:4px;"></div>
      </div>
      <table id="orderReportTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Order Code</th>
            <th>Items</th>
            <th>Qty</th>
            <th>Subtotal</th>
            <th>Discount</th>
            <th>Tax</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filled dynamically -->
        </tbody>
        <!-- Order Report Table Total -->
        <tfoot>
          <tr>
            <td colspan="7" style="text-align:right;font-weight:bold;">Total Orders:</td>
            <td id="ordersTotal" style="font-weight:bold;color:#2563eb;"></td>
          </tr>
        </tfoot>
      </table>
    </section>

    <!-- Stock Movement Report -->
    <section>
      <h2>Stock Movement Report</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <input id="stockSearch" type="text" placeholder="Search Stock Movements..." style="padding:6px 12px;border-radius:6px;border:1px solid #ccc;min-width:180px;">
        <div id="stockPagination" style="display:flex;gap:4px;"></div>
      </div>
      <table id="stockMovementTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Product Variant</th>
            <th>Type</th>
            <th>Quantity</th>
            <th>Warehouse</th>
            <th>Batch</th>
            <th>Reason</th>
            <th>Reference</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filled dynamically -->
        </tbody>
      </table>
    </section>
  </div>
<script src="assets/js/script.js"></script>
 <script src="config.js"></script>
<script>
  async function loadReports() {
    try {
      const API_BASE = window.BASE_URL;
      const token = localStorage.getItem('token');
      const headers = { Authorization: `Bearer ${token}` };

      // Fetch data
      const [ordersRes, stockMovementsRes] = await Promise.all([
        axios.get(`${API_BASE}/order`, { headers }),
        axios.get(`${API_BASE}/stock-movement`, { headers })
      ]);
      const orders = Array.isArray(ordersRes.data) ? ordersRes.data : (ordersRes.data.orders || []);
      const stockMovements = Array.isArray(stockMovementsRes.data) ? stockMovementsRes.data : (stockMovementsRes.data.stockMovements || stockMovementsRes.data);

      // Pagination and search state
      const itemsPerPage = 10;
      let salesPage = 1, orderPage = 1, stockPage = 1;
      let salesSearch = '', orderSearch = '', stockSearch = '';

      // --- Render Functions ---
      function renderSalesTable() {
        const tbody = document.querySelector('#salesReportTable tbody');
        let filtered = orders.filter(o =>
          (o.orderCode || '').toLowerCase().includes(salesSearch) ||
          (o.customer?.name || '').toLowerCase().includes(salesSearch) ||
          (o.channel || '').toLowerCase().includes(salesSearch) ||
          (o.status || '').toLowerCase().includes(salesSearch) ||
          (o.paymentMethod || '').toLowerCase().includes(salesSearch)
        );
        const totalPages = Math.ceil(filtered.length / itemsPerPage) || 1;
        salesPage = Math.min(salesPage, totalPages);
        const paginated = filtered.slice((salesPage - 1) * itemsPerPage, salesPage * itemsPerPage);
        tbody.innerHTML = paginated.map(o => `
          <tr>
            <td>${o.createdAt ? new Date(o.createdAt).toLocaleDateString() : '-'}</td>
            <td>${o.orderCode || '-'}</td>
            <td>${o.customer?.name || '-'}</td>
            <td>${o.channel || '-'}</td>
            <td>${o.status || '-'}</td>
            <td>₦${o.total ? Number(o.total).toLocaleString() : '0'}</td>
            <td>${o.paymentMethod || '-'}</td>
          </tr>
        `).join('');
        // Pagination controls
        const pagDiv = document.getElementById('salesPagination');
        pagDiv.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          btn.style = `padding:3px 10px;border-radius:4px;border:1px solid #2563eb;background:${i===salesPage?'#2563eb':'#fff'};color:${i===salesPage?'#fff':'#2563eb'};cursor:pointer;`;
          btn.onclick = () => { salesPage = i; renderSalesTable(); };
          pagDiv.appendChild(btn);
        }
        // Total
        const salesTotal = filtered.reduce((sum, o) => sum + (Number(o.total) || 0), 0);
        document.getElementById('salesTotal').textContent = `₦${salesTotal.toLocaleString(undefined, {minimumFractionDigits:2})}`;
      }

      function renderOrderTable() {
        const tbody = document.querySelector('#orderReportTable tbody');
        let filtered = orders.filter(o =>
          (o.orderCode || '').toLowerCase().includes(orderSearch) ||
          (Array.isArray(o.items) ? o.items.map(i => i.productVariantName || '-').join(', ').toLowerCase() : '').includes(orderSearch) ||
          (o.status || '').toLowerCase().includes(orderSearch)
        );
        const totalPages = Math.ceil(filtered.length / itemsPerPage) || 1;
        orderPage = Math.min(orderPage, totalPages);
        const paginated = filtered.slice((orderPage - 1) * itemsPerPage, orderPage * itemsPerPage);
        tbody.innerHTML = paginated.map(o => {
          const qty = Array.isArray(o.items) ? o.items.reduce((sum, item) => sum + (item.qty || 0), 0) : 0;
          const discount = Array.isArray(o.discounts)
            ? o.discounts.reduce((sum, d) => {
                if (d.type === 'fixed') return sum + (d.value || 0);
                if (d.type === 'percent') return sum + ((o.subTotal || 0) * (d.value || 0)) / 100;
                return sum;
              }, 0)
            : 0;
          return `
            <tr>
              <td>${o.createdAt ? new Date(o.createdAt).toLocaleDateString() : '-'}</td>
              <td>${o.orderCode || '-'}</td>
              <td>${Array.isArray(o.items) ? o.items.map(i => i.productVariantName || '-').join(', ') : '-'}</td>
              <td>${qty}</td>
              <td>₦${o.subTotal ? Number(o.subTotal).toLocaleString(undefined, {minimumFractionDigits:2}) : '0.00'}</td>
              <td>₦${discount ? discount.toLocaleString(undefined, {minimumFractionDigits:2}) : '0.00'}</td>
              <td>₦${o.tax ? Number(o.tax).toLocaleString(undefined, {minimumFractionDigits:2}) : '0.00'}</td>
              <td>₦${o.total ? Number(o.total).toLocaleString(undefined, {minimumFractionDigits:2}) : '0.00'}</td>
            </tr>
          `;
        }).join('');
        // Pagination controls
        const pagDiv = document.getElementById('orderPagination');
        pagDiv.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          btn.style = `padding:3px 10px;border-radius:4px;border:1px solid #2563eb;background:${i===orderPage?'#2563eb':'#fff'};color:${i===orderPage?'#fff':'#2563eb'};cursor:pointer;`;
          btn.onclick = () => { orderPage = i; renderOrderTable(); };
          pagDiv.appendChild(btn);
        }
        // Total
        const ordersTotal = filtered.reduce((sum, o) => sum + (Number(o.subTotal) || 0), 0);
        document.getElementById('ordersTotal').textContent = `₦${ordersTotal.toLocaleString(undefined, {minimumFractionDigits:2})}`;
      }

      function renderStockTable() {
        const tbody = document.querySelector('#stockMovementTable tbody');
        let filtered = Array.isArray(stockMovements) ? stockMovements.filter(m =>
          (m.productVariant?.name || '').toLowerCase().includes(stockSearch) ||
          (m.type || '').toLowerCase().includes(stockSearch) ||
          (m.warehouse?.name || '').toLowerCase().includes(stockSearch) ||
          (m.batchNumber || '').toLowerCase().includes(stockSearch) ||
          (m.reason || '').toLowerCase().includes(stockSearch) ||
          (m.reference || '').toLowerCase().includes(stockSearch)
        ) : [];
        const totalPages = Math.ceil(filtered.length / itemsPerPage) || 1;
        stockPage = Math.min(stockPage, totalPages);
        const paginated = filtered.slice((stockPage - 1) * itemsPerPage, stockPage * itemsPerPage);
        tbody.innerHTML = paginated.length ? paginated.map(m => `
          <tr>
            <td>${m.createdAt ? new Date(m.createdAt).toLocaleDateString() : '-'}</td>
            <td>${m.productVariant?.name || '-'}</td>
            <td>${m.type || '-'}</td>
            <td>${m.quantity || 0}</td>
            <td>${m.warehouse?.name || '-'}</td>
            <td>${m.batchNumber || '-'}</td>
            <td>${m.reason || '-'}</td>
            <td>${m.reference || '-'}</td>
          </tr>
        `).join('') : `<tr><td colspan="8" style="text-align:center;">No stock movement data</td></tr>`;
        // Pagination controls
        const pagDiv = document.getElementById('stockPagination');
        pagDiv.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          btn.style = `padding:3px 10px;border-radius:4px;border:1px solid #2563eb;background:${i===stockPage?'#2563eb':'#fff'};color:${i===stockPage?'#fff':'#2563eb'};cursor:pointer;`;
          btn.onclick = () => { stockPage = i; renderStockTable(); };
          pagDiv.appendChild(btn);
        }
      }

      // --- Event Listeners for Search ---
      document.getElementById('salesSearch').addEventListener('input', e => {
        salesSearch = e.target.value.trim().toLowerCase();
        salesPage = 1;
        renderSalesTable();
      });
      document.getElementById('orderSearch').addEventListener('input', e => {
        orderSearch = e.target.value.trim().toLowerCase();
        orderPage = 1;
        renderOrderTable();
      });
      document.getElementById('stockSearch').addEventListener('input', e => {
        stockSearch = e.target.value.trim().toLowerCase();
        stockPage = 1;
        renderStockTable();
      });

      // --- Initial Render ---
      renderSalesTable();
      renderOrderTable();
      renderStockTable();

    } catch (err) {
      alert('Error loading reports: ' + (err.response?.data?.message || err.message));
      console.error(err);
    }
  }

  document.addEventListener('DOMContentLoaded', loadReports);
</script>
</body>
</html>
