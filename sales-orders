<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eraskon Inventory Management</title>

  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <!-- <link rel="stylesheet" href="assets/css/style.css"> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <script src="assets/js/metaManager.js"></script>
  <script>
    setMeta({
      title: "Eraskon | Sales",
      desc: "Access the Eraskon Inventory portal to manage sales.",
      image: "assets/images/eraskon_logo.webp",
      favicon: "assets/images/eraskon_logo.webp",
      keywords: "Inventory, Warehouse, Stock, Sales"
    });
  </script>
  <style>
    /* 1. SIMPLIFIED COLOR VARIABLES FOR BALANCE */
    :root {
      --bg-light: #f3f4f6;
      /* Tailwind gray-100 */
      --bg-dark: #0f172a;
      /* Tailwind slate-900 */
      --text-light: #1f2937;
      /* Tailwind gray-800 */
      --text-dark: #f9fafb;
      /* Tailwind gray-50 */
      --card-bg-light: #ffffff;
      /* Pure White */
      --card-bg-dark: #1e293b;
      /* Tailwind slate-800 */
      --primary-color: #3b82f6;
      /* Tailwind blue-500 */
      --secondary-text-light: #6b7280;
      /* Tailwind gray-500 */
      --secondary-text-dark: #9ca3af;
      /* Tailwind gray-400 */

      /* Icon/Accent Colors */
      --icon-sales: #2563eb;
      --icon-orders: #10b981;
      /* Green */
      --icon-customers: #f97316;
      /* Orange */
      --icon-returns: #ef4444;
      /* Red */
      --icon-team: #7c3aed;
      /* Purple */
    }

    /* Base Styling */
    body {
      background-color: var(--bg-light);
      color: var(--text-light);
      transition: all 0.5s ease-in-out;
      /* Balanced Font: Using system defaults which are usually clear and balanced */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }

    /* Dark Mode Styling */
    .dark {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    /* Card/Container Overrides for consistency */
    .bg-white,
    .dark .bg-white,
    .dark .bg-gray-800,
    .card {
      /* 2. Consistent Container Colors */
      background-color: var(--card-bg-light) !important;
      color: var(--text-light) !important;
      transition: background-color 0.5s, color 0.5s;
      /* 3. Consistent Border/Shadow */
      border-radius: 1rem !important;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
    }

    .dark .bg-white,
    .dark .bg-gray-800,
    .dark .card {
      background-color: var(--card-bg-dark) !important;
      color: var(--text-dark) !important;
      border: 1px solid #334155;
      /* Subtle border in dark mode */
    }

    /* Text Color Adjustments */
    .card-title,
    .text-gray-800 {
      color: var(--text-light);
    }

    .dark .card-title,
    .dark .text-gray-800 {
      color: var(--text-dark);
    }

    .card-text.small,
    .text-gray-500 {
      color: var(--secondary-text-light);
    }

    .dark .card-text.small,
    .dark .text-gray-500,
    .dark .text-gray-400 {
      color: var(--secondary-text-dark) !important;
    }


    /* Icon Card Styling */
    .card-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin: 0 auto 1rem auto;
      font-size: 2rem;
      transition: background 0.3s;
    }

    .icon-sales {
      background: var(--icon-sales);
      color: #fff;
    }

    .icon-orders {
      background: var(--icon-orders);
      color: #fff;
    }

    .icon-customers {
      background: var(--icon-customers);
      color: #fff;
    }

    .icon-returns {
      background: var(--icon-returns);
      color: #fff;
    }

    .icon-team {
      background: var(--icon-team);
      color: #fff;
    }

    .main-content {
      margin-left: 250px;
      margin-top: 60px;
      padding: 20px;
      min-height: calc(100vh - 60px);
    }

    @media (max-width: 900px) {
      .main-content {
        margin-left: 0 !important;
        width: 100vw !important;
        padding: 10px;
      }
    }

    .badge {
      padding: 4px 8px;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 0.75rem;
      display: inline-block;
    }

    .status-created {
      background-color: #3b82f6;
      color: white;
    }

    .status-completed {
      background-color: #10b981;
      color: white;
    }

    /* Custom styles for radio button group */
    .radio-group input[type="radio"] {
      display: none;
    }

    .radio-group label {
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s;
      border: 1px solid transparent;
      color: var(--text-light);
    }

    .dark .radio-group label {
      color: var(--text-dark);
    }

    .radio-group input[type="radio"]:checked+label {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .radio-group label:hover {
      background-color: #e5e7eb;
      /* Tailwind gray-200 */
    }

    .dark .radio-group label:hover:not(.checked) {
      background-color: #334155;
      /* Darker background */
    }
  </style>
</head>


<body :class="{ 'dark': darkMode }">
  <script src="components/uiComponents.js"></script>
  <script src="components/spinner.js"></script>
  <script src="components/authGuard.js"></script>
  <script src="components/navbar.js"></script>
  <script src="components/sidebar.js"></script>

  <main id="app" class="main-content">
    <h1 class="text-3xl font-bold mb-6 text-gray-800 dark:text-gray-50 flex items-center">
      <i class='bx bx-shopping-bag mr-3 text-primary-color'></i> Sales Management
    </h1>

    <div class="mb-6 flex flex-col sm:flex-row justify-start items-start sm:items-center gap-4">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-50">Filter Performance:</h3>
      <div class="radio-group flex gap-2 p-1 bg-gray-100 dark:bg-gray-700 rounded-xl">
        <input type="radio" id="mtd" value="MTD" v-model="timeFilter">
        <label for="mtd">Month-to-Date</label>

        <input type="radio" id="wtd" value="WTD" v-model="timeFilter">
        <label for="wtd">Week-to-Date</label>

        <input type="radio" id="ytd" value="YTD" v-model="timeFilter">
        <label for="ytd">Year-to-Date</label>

        <input type="radio" id="all" value="ALL" v-model="timeFilter">
        <label for="all">All Time</label>
      </div>
    </div>
    <hr class="mb-6 dark:border-gray-700" />


    <div class="row g-4 mb-8">
      <div class="col-sm-6 col-md-4 col-lg-3" v-for="(card, index) in performanceCards" :key="index">
        <div class="card h-100 p-4 border-0 shadow-lg animate__animated animate__fadeInUp"
          :class="darkMode ? 'bg-dark text-white' : 'bg-white text-dark'"
          :style="`animation-delay: ${index * 100}ms; animation-duration: 600ms; transition: transform 0.3s ease, box-shadow 0.3s ease;`">
          <div class="card-body text-center">
            <div class="mb-3">
              <span :class="['card-icon', card.iconClass]">
                <i :class="['bx', card.icon]"></i>
              </span>
            </div>
            <h5 class="card-title fw-semibold text-gray-500 dark:text-gray-400">{{ card.title }}</h5>
            <h3 class="card-text fw-bold mb-2 text-2xl">{{ card.amount }}</h3>
            <p class="card-text small text-gray-500 dark:text-gray-400">
              {{ card.description }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <hr class="mb-6 dark:border-gray-700" />

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-50">
          Sales Performance by Agent ({{ timeFilter }})
        </h2>
        <div class="h-96">
          <canvas id="salesAgentChart"></canvas>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-50">
          Your Performance ({{ timeFilter }})
        </h2>
        <div class="space-y-4">
          <div class="p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
            <p class="text-sm font-medium text-blue-600 dark:text-blue-300">Total Sales</p>
            <p class="text-2xl font-bold text-gray-800 dark:text-white">
              ₦{{ currentAgentPerformance.totalSales.toLocaleString() }}
            </p>
          </div>
          <div class="p-3 bg-green-50 dark:bg-green-900 rounded-lg">
            <p class="text-sm font-medium text-green-600 dark:text-green-300">Total Orders</p>
            <p class="text-2xl font-bold text-gray-800 dark:text-white">
              {{ currentAgentPerformance.orderCount.toLocaleString() }}
            </p>
          </div>
          <div class="p-3 bg-purple-50 dark:bg-purple-900 rounded-lg">
            <p class="text-sm font-medium text-purple-600 dark:text-purple-300">Average Order Value</p>
            <p class="text-2xl font-bold text-gray-800 dark:text-white">
              ₦{{ currentAgentPerformance.aov.toLocaleString() }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <hr class="mb-6 dark:border-gray-700" />


    <div class="bg-white rounded-2xl shadow-xl p-6">
      <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-50">
        Recent Orders ({{ userRole === 'admin' ? 'Global View' : userWarehouse + ' Warehouse' }})
      </h2>
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3">
        <input type="text" v-model="searchQuery" placeholder="Search orders..."
          class="border border-gray-300 dark:border-gray-600 px-3 py-2 rounded-lg w-full sm:w-64 focus:ring-blue-500 focus:border-blue-500 transition duration-200 dark:bg-gray-700 dark:text-gray-50" />
        <div class="flex gap-2">
          <button v-if="userRole === 'admin' || userRole === 'sales'"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-200 flex items-center">
            <i class='bx bx-plus mr-2'></i> Create New Sale
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full table-auto text-sm divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Order ID</th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Customer</th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Warehouse</th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Agent</th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Amount</th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Status</th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Date</th>
              <th
                class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            <tr v-for="(order, index) in paginatedOrders" :key="order.orderCode"
              class="hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-150">
              <td class="px-4 py-3 whitespace-nowrap">{{ order.orderCode }}</td>
              <td class="px-4 py-3 whitespace-nowrap">
                {{ order.customer && order.customer.name ? order.customer.name : 'N/A' }}
              </td>
              <td class="px-4 py-3 whitespace-nowrap">{{ order.warehouse || 'N/A' }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-600 dark:text-gray-300">
                {{ order.createdBy?.name || 'System' }}
              </td>
              <td class="px-4 py-3 whitespace-nowrap font-medium">₦{{ (Number(order.total) || 0).toLocaleString() }}</td>
              <td class="px-4 py-3 whitespace-nowrap">
                <span :class="getStatusBadgeClass(order.status)" class="badge">{{ order.status }}</span>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-gray-500 dark:text-gray-400">{{ formatDate(order.createdAt)
                }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-center">
                <button @click="viewOrderDetails(order)"
                  class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200 transition duration-150 mx-1"
                  title="View Details">
                  <i class='bx bx-search-alt text-lg'></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        <div v-if="paginatedOrders.length === 0" class="text-center py-8 text-gray-500 dark:text-gray-400">
          No orders found matching your criteria.
        </div>
      </div>

      <div class="mt-6 flex justify-between items-center px-4">
        <span class="text-sm text-gray-700 dark:text-gray-400">
          Showing {{ (currentPage - 1) * rowsPerPage + 1 }} to {{ Math.min(currentPage * rowsPerPage,
          filteredOrders.length) }} of {{ filteredOrders.length }} results
        </span>
        <div class="flex gap-4">
          <button @click="prevPage" :disabled="currentPage === 1"
            class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-50 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition duration-200">Prev</button>
          <button @click="nextPage" :disabled="currentPage === totalPages || totalPages === 0"
            class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-50 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition duration-200">Next</button>
        </div>
      </div>
    </div>


  </main>
  <script src="assets/js/script.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="config.js"></script>

  <script>
    const API_BASE = window.BASE_URL;
    const { createApp } = Vue;

    let salesChartInstance = null;

    createApp({
      data() {
        // NOTE: The current date for simulation is Nov 11, 2025.
        return {
          // --- User Context (Simulated RBAC Data) ---
          userRole: localStorage.getItem('role') || 'sales', // Default to 'sales'
          userWarehouse: localStorage.getItem('warehouse') || 'Lagos', // Default to 'Lagos'
          currentUserId: 'agent_lagos_1', // Simulated current logged-in user ID (for "Your Performance")

          // --- UI/Table State ---
          darkMode: localStorage.getItem('darkMode') === 'true',
          searchQuery: '',
          currentPage: 1,
          rowsPerPage: 10,
          allOrders: [],
          
          // --- Performance State ---
          timeFilter: 'MTD', // MTD, WTD, YTD, ALL
        };
      },
      computed: {
        // --- Core Data Filtering based on RBAC ---
        rbacOrders() {
          const role = this.userRole.toLowerCase();
          const warehouse = this.userWarehouse.toLowerCase();

          if (role === 'admin' || role === 'chairman') {
            return this.allOrders;
          } else if (role === 'sales') {
            return this.allOrders.filter(order =>
              (order.warehouse || '').toLowerCase() === warehouse
            );
          }
          return [];
        },

        // --- Date Filtering (MTD, WTD, YTD) ---
        dateFilteredOrders() {
          if (this.timeFilter === 'ALL') return this.rbacOrders;

          // Simulation Time: Nov 11, 2025
          const now = new Date('2025-11-11T00:00:00Z'); 
          let startDate;

          if (this.timeFilter === 'MTD') {
            // Month-to-Date: Nov 1, 2025
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          } else if (this.timeFilter === 'WTD') {
            // Week-to-Date: Start of the current week (Sunday, Nov 9, 2025)
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
            startDate.setHours(0, 0, 0, 0);
          } else if (this.timeFilter === 'YTD') {
            // Year-to-Date: Jan 1, 2025
            startDate = new Date(now.getFullYear(), 0, 1);
          }

          return this.rbacOrders.filter(order => {
            const orderDate = new Date(order.createdAt);
            return orderDate >= startDate && orderDate <= now;
          });
        },

        // --- UI Computations ---
        filteredOrders() {
          let list = this.dateFilteredOrders;
          if (this.searchQuery) {
            const query = this.searchQuery.toLowerCase();
            list = list.filter(order =>
              String(order.orderCode).toLowerCase().includes(query) ||
              String(order.total).toLowerCase().includes(query) ||
              String(order.status).toLowerCase().includes(query) ||
              String(order.warehouse).toLowerCase().includes(query) ||
              String(order.createdBy?.name).toLowerCase().includes(query) ||
              (order.customer && String(order.customer.name).toLowerCase().includes(query))
            );
          }
          return list;
        },
        totalPages() {
          return Math.ceil(this.filteredOrders.length / this.rowsPerPage);
        },
        paginatedOrders() {
          const start = (this.currentPage - 1) * this.rowsPerPage;
          return this.filteredOrders.slice(start, start + this.rowsPerPage);
        },

        // --- Performance Card Data ---
        performanceCards() {
          const orders = this.dateFilteredOrders;
          const totalSales = orders.reduce((sum, o) => sum + (Number(o.total) || 0), 0);
          const orderCount = orders.length;
          const customerSet = new Set(orders.map(o => o.customer?.name || o.customer));
          const returnsCount = orders.filter(o => (o.status || '').toLowerCase() === 'returned').length;

          return [
            {
              title: 'Total Revenue',
              amount: `₦${totalSales.toLocaleString()}`,
              description: `${this.timeFilter} sales revenue`,
              icon: 'bx-dollar-circle',
              iconClass: 'icon-sales'
            },
            {
              title: 'Total Orders',
              amount: orderCount.toLocaleString(),
              description: `${this.timeFilter} orders count`,
              icon: 'bx-receipt',
              iconClass: 'icon-orders'
            },
            {
              title: 'Unique Customers',
              amount: customerSet.size.toLocaleString(),
              description: 'Unique customers served',
              icon: 'bx-group',
              iconClass: 'icon-customers'
            },
            {
              title: 'Returned Orders',
              amount: returnsCount.toLocaleString(),
              description: `Returns in ${this.timeFilter} period`,
              icon: 'bx-undo',
              iconClass: 'icon-returns'
            }
          ];
        },

        // --- Chart Data ---
        salesAgentData() {
          const salesByAgent = {};

          this.dateFilteredOrders.forEach(order => {
            const agentName = order.createdBy?.name || 'Unassigned';
            const total = Number(order.total) || 0;

            if (!salesByAgent[agentName]) {
              salesByAgent[agentName] = { totalSales: 0, orderCount: 0 };
            }
            salesByAgent[agentName].totalSales += total;
            salesByAgent[agentName].orderCount += 1;
          });

          const sortedAgents = Object.keys(salesByAgent).map(name => ({
            name,
            ...salesByAgent[name]
          })).sort((a, b) => b.totalSales - a.totalSales);

          return {
            labels: sortedAgents.map(a => a.name),
            sales: sortedAgents.map(a => a.totalSales)
          };
        },

        // --- Current Agent Summary ---
        currentAgentPerformance() {
            const agentOrders = this.dateFilteredOrders.filter(order => 
                order.createdBy?.id === this.currentUserId
            );
            
            const totalSales = agentOrders.reduce((sum, o) => sum + (Number(o.total) || 0), 0);
            const orderCount = agentOrders.length;
            const aov = orderCount > 0 ? totalSales / orderCount : 0;

            return {
                totalSales: Math.round(totalSales),
                orderCount: orderCount,
                aov: Math.round(aov)
            };
        }
      },
      watch: {
        darkMode(newVal) {
          document.documentElement.classList.toggle('dark', newVal);
          localStorage.setItem('darkMode', newVal);
          this.$nextTick(() => this.renderSalesChart());
        },
        searchQuery() {
          this.currentPage = 1;
        },
        timeFilter() {
          this.currentPage = 1;
          this.renderSalesChart();
        },
        salesAgentData: {
          handler() {
            this.renderSalesChart();
          },
          deep: true,
        }
      },
      methods: {
        // --- Utility Methods ---
        toggleDarkMode() {
          this.darkMode = !this.darkMode;
        },
        formatDate(dateString) {
          const options = { year: 'numeric', month: 'short', day: 'numeric' };
          return new Date(dateString).toLocaleDateString(undefined, options);
        },
        getStatusBadgeClass(status) {
          const lowerStatus = (status || '').toLowerCase();
          if (lowerStatus === 'created') return 'status-created';
          if (lowerStatus === 'completed') return 'status-completed';
          if (lowerStatus === 'pending') return 'bg-yellow-500 text-white';
          if (lowerStatus === 'returned') return 'bg-red-500 text-white';
          if (lowerStatus === 'shipped') return 'bg-blue-500 text-white';
          return 'bg-gray-400 text-white';
        },

        // --- Pagination Methods ---
        nextPage() {
          if (this.currentPage < this.totalPages) this.currentPage++;
        },
        prevPage() {
          if (this.currentPage > 1) this.currentPage--;
        },
        viewOrderDetails(order) {
          alert(`Viewing details for Order ID: ${order.orderCode} (Edit/Delete blocked)`);
        },

        // --- Chart Rendering ---
        renderSalesChart() {
          if (salesChartInstance) {
            salesChartInstance.destroy();
          }

          const ctx = document.getElementById('salesAgentChart').getContext('2d');
          const data = this.salesAgentData;
          const chartConfig = {
            type: 'bar',
            data: {
              labels: data.labels,
              datasets: [{
                label: `Total Sales Revenue (${this.timeFilter})`,
                data: data.sales,
                backgroundColor: this.darkMode ? '#3b82f6' : '#2563eb', // Blue
                borderColor: this.darkMode ? '#2563eb' : '#1e40af',
                borderWidth: 1,
                borderRadius: 6,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Revenue (₦)',
                    color: this.darkMode ? 'white' : 'black',
                  },
                  ticks: {
                    color: this.darkMode ? 'white' : 'black',
                    callback: function(value) {
                      return '₦' + (value / 1000).toLocaleString() + 'K';
                    }
                  },
                  grid: {
                    color: this.darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: 'Sales Agent',
                    color: this.darkMode ? 'white' : 'black',
                  },
                  ticks: {
                    color: this.darkMode ? 'white' : 'black',
                  },
                  grid: {
                    color: this.darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                  }
                }
              },
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      let label = context.dataset.label || '';
                      if (label) {
                        label += ': ';
                      }
                      if (context.parsed.y !== null) {
                        label += '₦' + context.parsed.y.toLocaleString();
                      }
                      return label;
                    }
                  }
                }
              }
            }
          };

          salesChartInstance = new Chart(ctx, chartConfig);
        },

        // --- Data Fetching with RBAC and Enrichment (SIMULATION) ---
        async fetchOrders() {
          const simulatedData = this.createSimulatedOrders();
          this.allOrders = simulatedData;

          const storedRole = localStorage.getItem('role');
          const storedWarehouse = localStorage.getItem('warehouse');
          
          this.userRole = storedRole || 'admin'; 
          this.userWarehouse = storedWarehouse || 'Abuja';
          
          if (this.userRole.toLowerCase() === 'sales') {
            this.currentUserId = this.userWarehouse.toLowerCase() === 'lagos' ? 'agent_lagos_1' : (this.userWarehouse.toLowerCase() === 'abuja' ? 'agent_abuja_1' : 'agent_ph_1');
          } else {
            // Admin default to a specific agent for "Your Performance" summary
            this.currentUserId = 'agent_abuja_1';
          }

          this.renderSalesChart();
        },

        // --- Helper to Enrich and Simulate Data ---
        createSimulatedOrders() {
          const agents = [
            { id: 'agent_lagos_1', name: 'Tunde Sales', warehouse: 'Lagos' },
            { id: 'agent_lagos_2', name: 'Amaka Sales', warehouse: 'Lagos' },
            { id: 'agent_abuja_1', name: 'Chidi Sales', warehouse: 'Abuja' },
            { id: 'agent_abuja_2', name: 'Fatima Sales', warehouse: 'Abuja' },
            { id: 'agent_ph_1', name: 'Godwin Sales', warehouse: 'Port Harcourt' },
          ];

          // Dates relative to Nov 11, 2025:
          // MTD: Nov 1 - 11
          // WTD: Nov 9 - 11
          // YTD: Jan 1 - Nov 11

          const baseOrders = [
            // MTD/WTD - Lagos 1 (Tunde)
            { orderCode: 'ORD-1001', customer: { name: 'Customer A' }, total: 450000, status: 'completed', createdAt: '2025-11-10T10:00:00Z' }, // WTD
            { orderCode: 'ORD-1002', customer: { name: 'Customer B' }, total: 85000, status: 'completed', createdAt: '2025-11-05T15:30:00Z' }, // MTD
            // MTD - Lagos 2 (Amaka)
            { orderCode: 'ORD-1003', customer: { name: 'Customer C' }, total: 220000, status: 'created', createdAt: '2025-11-09T09:00:00Z' }, // WTD
            { orderCode: 'ORD-1004', customer: { name: 'Customer D' }, total: 700000, status: 'completed', createdAt: '2025-11-02T11:00:00Z' }, // MTD
            // YTD/OLD - Lagos 2 (Amaka)
            { orderCode: 'ORD-1005', customer: { name: 'Customer E' }, total: 350000, status: 'created', createdAt: '2024-09-01T08:00:00Z' }, 
            // MTD/WTD - Abuja 1 (Chidi)
            { orderCode: 'ORD-1006', customer: { name: 'Customer F' }, total: 1200000, status: 'completed', createdAt: '2025-11-11T08:00:00Z' }, // WTD
            { orderCode: 'ORD-1007', customer: { name: 'Customer G' }, total: 45000, status: 'returned', createdAt: '2025-11-03T14:00:00Z' }, // MTD
            // YTD - Abuja 2 (Fatima)
            { orderCode: 'ORD-1008', customer: { name: 'Customer H' }, total: 180000, status: 'completed', createdAt: '2025-01-20T16:00:00Z' },
            // MTD - PH 1 (Godwin)
            { orderCode: 'ORD-1009', customer: { name: 'Customer I' }, total: 90000, status: 'created', createdAt: '2025-11-06T17:00:00Z' },
          ];

          const assignments = [
              agents[0], agents[0], agents[1], agents[1], agents[1], 
              agents[2], agents[2], agents[3], agents[4]
          ];
          
          return baseOrders.map((order, index) => {
            const agent = assignments[index];
            return {
              ...order,
              warehouse: agent.warehouse,
              createdBy: {
                id: agent.id,
                name: agent.name
              }
            };
          });
        }
      },
      mounted() {
        document.documentElement.classList.toggle('dark', this.darkMode);
        this.fetchOrders();
      }
    }).mount('#app');
  </script>
</body>

</html>