<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inventory Check</title>

    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="assets/js/metaManager.js"></script>
    <script>
        // Assuming setMeta is available via metaManager.js
        setMeta({
            title: "Eraskon | Inventory Check",
            desc: "Review current stock levels and reorder statuses.",
            image: "assets/images/eraskon_logo.webp",
            favicon: "assets/images/eraskon_logo.webp",
            keywords: "Inventory, Warehouse, Stock, Reorder"
        });
    </script>
    <style>
        /* Re-using or adapting the existing CSS from your provided code */
        :root {
            --bg-color: #e2dcdc;
            --text-color: #090F3B;
            --card-bg: #ffffff;
            --border-color: #ccc;
            --input-border: #ccc;
        }

        body.dark {
            --bg-color: #090F3B;
            --text-color: #f1f1f1;
            --card-bg: #050d4a;
            --border-color: #444;
            --input-border: #444;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin-top: 1rem;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        th {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body.dark th {
            background-color: rgba(255, 255, 255, 0.05);
        }

        tr:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        body.dark tr:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .status-low {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-ok {
            color: #27ae60;
            font-weight: bold;
        }
        
        .inline-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>

</head>

<body>
    <script src="components/uiComponents.js"></script>
    <script src="components/authGuard.js"></script>
    <script src="components/navbar.js"></script>

    <script src="components/sidebar.js"></script>

    <main id="app" class="main-content">
        <h2>ðŸ“¦ Inventory Check</h2>

        <div v-if="loadingWarehouse">Loading warehouse data...</div>
        <div v-else-if="fetchError">
            <p style="color: red;">Error: {{ fetchError }}</p>
        </div>
        <div v-else-if="!userWarehouse">
            <p style="color: red;">Error: Could not determine user's warehouse or access is restricted.</p>
        </div>
        
        <div v-else>
            <div class="card" style="max-width: none;">
                <h3>{{ userWarehouse.name }}</h3>
                <p><strong>Location:</strong> {{ userWarehouse.location }}</p>
                <p><strong>Total Unique Products:</strong> {{ productVariants.length }}</p>
                <p><strong>Stock Status:</strong> <span :class="{'status-low': productsBelowReorder.length > 0, 'status-ok': productsBelowReorder.length === 0}">
                    {{ productsBelowReorder.length > 0 ? 'Urgent Reorder Needed' : 'All Levels OK' }}
                </span></p>
            </div>
            
            <div class="inline-row" style="margin-top: 1rem;">
                <input type="text" v-model="filters.search" placeholder="Search product name/SKU">
                <select v-model="filters.status">
                    <option value="">All Statuses</option>
                    <option value="low">Below Reorder Level</option>
                    <option value="ok">Above Reorder Level</option>
                </select>
            </div>


            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>SKU</th>
                        <th>Current Stock</th>
                        <th>Reorder Level</th>
                        <th>Status</th>
                        <th>Last Updated</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="p in filteredProductVariants" :key="p._id">
                        <td>{{ p.name }}</td>
                        <td>{{ p.sku || 'N/A' }}</td>
                        <td>{{ p.stock }}</td>
                        <td>{{ p.reorderLevel || 'N/A' }}</td>
                        <td>
                            <span :class="getStockStatusClass(p.stock, p.reorderLevel)">
                                {{ getStockStatus(p.stock, p.reorderLevel) }}
                            </span>
                        </td>
                        <td>{{ formatDate(p.updatedAt) }}</td>
                    </tr>
                    <tr v-if="filteredProductVariants.length === 0">
                        <td colspan="6" style="text-align: center;">No inventory records found for this warehouse or matching filters.</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
    </main>

    <script src="config.js"></script>
    <script src="assets/js/script.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 1. Setup Axios Authorization Header
            const token = localStorage.getItem('token');
            if (token) {
                axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
            }
            
            // Define the API endpoints
            const PRODUCT_API = window.BASE_URL + '/product-variant';
            const WAREHOUSE_API = 'https://api.eraskon.com/warehouse'; 

            new Vue({
                el: '#app',
                data: {
                    loadingWarehouse: true,
                    userWarehouse: null,
                    productVariants: [],
                    fetchError: null,
                    
                    filters: {
                        search: '',
                        status: ''
                    }
                },
                computed: {
                    productsBelowReorder() {
                        return this.productVariants.filter(p => p.reorderLevel && p.stock <= p.reorderLevel);
                    },
                    filteredProductVariants() {
                        let filtered = this.productVariants;

                        // 1. Search Filter
                        if (this.filters.search) {
                            const searchLower = this.filters.search.toLowerCase();
                            filtered = filtered.filter(p => 
                                (p.name && p.name.toLowerCase().includes(searchLower)) ||
                                (p.sku && p.sku.toLowerCase().includes(searchLower))
                            );
                        }

                        // 2. Status Filter
                        if (this.filters.status === 'low') {
                            filtered = filtered.filter(p => p.reorderLevel && p.stock <= p.reorderLevel);
                        } else if (this.filters.status === 'ok') {
                            filtered = filtered.filter(p => !p.reorderLevel || p.stock > p.reorderLevel);
                        }

                        return filtered;
                    }
                },
                mounted() {
                    this.fetchInventoryData();
                },
                methods: {
                    async fetchInventoryData() {
                        this.loadingWarehouse = true;
                        this.fetchError = null;
                        try {
                            // 2. Get the warehouse ID from localStorage
                            const warehouseId = localStorage.getItem('warehouseId');
                            
                            if (!warehouseId) {
                                // Specific error if ID is missing
                                this.fetchError = 'User is not assigned a Warehouse ID. Please check user settings.';
                                this.userWarehouse = null;
                                return;
                            }

                            // 3. Fetch the specific warehouse details
                            const whRes = await axios.get(`${WAREHOUSE_API}/${warehouseId}`);
                            this.userWarehouse = whRes.data; 

                            // 4. Fetch product variants (stock)
                            const stockRes = await axios.get(`${PRODUCT_API}/warehouse/${warehouseId}`);
                            this.productVariants = stockRes.data;

                        } catch (err) {
                            console.error('Error fetching inventory data:', err.response?.data || err.message);
                            // General API error message
                            this.fetchError = 'Failed to load inventory data. Check API connection or permissions.';
                            this.userWarehouse = null;
                        } finally {
                            this.loadingWarehouse = false;
                        }
                    },
                    formatDate(d) {
                        if (!d) return 'N/A';
                        return new Date(d).toLocaleDateString('en-US');
                    },
                    getStockStatus(stock, reorderLevel) {
                        if (!reorderLevel) return 'N/A';
                        if (stock <= reorderLevel) {
                            return 'LOW (Reorder)';
                        }
                        return 'OK';
                    },
                    getStockStatusClass(stock, reorderLevel) {
                        if (!reorderLevel) return '';
                        if (stock <= reorderLevel) {
                            return 'status-low';
                        }
                        return 'status-ok';
                    }
                }
            });
        });
    </script>
</body>

</html>